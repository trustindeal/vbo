<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Merotra â€” Hierarchical PON Tree (Levels preserved)</title>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="adv.css">

  <style>
    :root{font-family:Inter,system-ui,Arial}
    body{margin:0;padding:0;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);color:#111827}
    #chart { width:100%; height: calc(100vh - 64px); overflow:hidden; }
    .toolbar { display:flex; gap:8px; align-items:center }
    .search-input { width:220px; padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; display:none }
    @media (max-width:760px){ .search-input{ width:140px } }
  </style>
</head>

<body>

  <div class="header">
    <div>
      <div class="header-title">ğŸŒ Merotra Network â€” (Preserve Levels)</div>
      <div class="header-sub">Network â†’ Window â†’ OLT â†’ PON â†’ Level columns (sheet order preserved)</div>
    </div>

    <div class="toolbar">
      <select id="windowFilter"></select>
      <select id="oltFilter"></select>
      <select id="ponFilter"></select>
      <button id="clearFilters" class="btn btn-secondary">Clear</button>

      <button id="searchFold" class="search-folded">ğŸ” Search</button>
      <input id="searchInput" class="search-input" placeholder="Search user id or part..." />

      <button id="reloadBtn" class="btn">ğŸ”„ Refresh</button>
    </div>
  </div>

  <div id="chart"></div>
  <div id="tooltip" class="tooltip"></div>

  <!-- Popup -->
  <div id="popupModal" class="popup-backdrop" style="display:none">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
        <div>
          <h2 id="popupTitle" style="margin:0;font-size:16px"></h2>
          <div id="popupPath" style="font-size:12px;color:#475569"></div>
        </div>
        <button id="popupClose" class="btn btn-secondary" style="height:30px">Close</button>
      </div>
      <div id="popupMeta" style="font-size:13px;color:#334155;margin-bottom:8px"></div>
      <div style="max-height:60vh;overflow:auto">
        <table id="popupUsersTable" class="user-table"></table>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnShot" class="btn">ğŸ“¸ Screenshot</button>
        <button id="btnCsv" class="btn btn-secondary">ğŸ“Š CSV</button>
      </div>
    </div>
  </div>

<script>
/* ==========================================
   CONFIG & GLOBALS
========================================== */
const BOARD_URL =
 "https://script.google.com/macros/s/AKfycbzItUueYIqcUuCn2cDaTTrWIF0LiilUxOXhhL-4b4D9aUlEo8Ov9pasR44d6JSM3h1t/exec?mode=board";

let rawJson = null;
let colorByOlt = new Map();

const tooltip = document.getElementById('tooltip');
const reloadBtn = document.getElementById('reloadBtn');
const popupModal = document.getElementById('popupModal');
const popupClose = document.getElementById('popupClose');
const popupTitle = document.getElementById('popupTitle');
const popupPath  = document.getElementById('popupPath');
const popupMeta  = document.getElementById('popupMeta');
const popupUsers = document.getElementById('popupUsersTable');

const windowFilter = document.getElementById('windowFilter');
const oltFilter = document.getElementById('oltFilter');
const ponFilter = document.getElementById('ponFilter');
const clearFilters = document.getElementById('clearFilters');

const searchFold = document.getElementById('searchFold');
const searchInput = document.getElementById('searchInput');

document.getElementById('btnShot').addEventListener('click', downloadScreenshot);
document.getElementById('btnCsv').addEventListener('click', downloadCSV);
popupClose.addEventListener('click', ()=> popupModal.style.display='none');

reloadBtn.addEventListener('click', ()=> loadAndRender(true));
windowFilter.addEventListener('change', applyFiltersAndRender);
oltFilter.addEventListener('change', applyFiltersAndRender);
ponFilter.addEventListener('change', applyFiltersAndRender);

clearFilters.addEventListener('click', ()=>{
  windowFilter.value=''; oltFilter.value=''; ponFilter.value='';
  applyFiltersAndRender();
});

searchFold.addEventListener('click', ()=>{
  if (searchInput.style.display === 'none') {
    searchInput.style.display='inline-block';
    searchInput.focus();
  } else {
    searchInput.style.display='none';
    searchInput.value='';
    applyFiltersAndRender();
  }
});

searchInput.addEventListener('input', ()=> applyFiltersAndRender());

/* ==========================================
   HELPERS
========================================== */
function normalizeId(v){ return (v ?? "").toString().trim(); }
function getOltNumberFromPon(pon){
  const m = (pon || "").match(/O(\d+)/i);
  return m ? m[1] : "0";
}
function parsePonKey(pon){
  const m = (pon || "").match(/O(\d+)I(\d+)P(\d+)/i);
  if(!m) return {olt:9999, ip:9999, port:9999};
  return {olt:+m[1], ip:+m[2], port:+m[3]};
}
function ensureColorForOlt(olt){
  if(!colorByOlt.has(olt)){
    const idx = colorByOlt.size;
    const h = (idx * 50) % 360;
    colorByOlt.set(olt, `hsl(${h} 65% 45%)`);
  }
  return colorByOlt.get(olt);
}

/* ==========================================
   LOADING & FILTERING
========================================== */
async function loadAndRender(showToast=false){
  try {
    setLoading(true);
    const res = await fetch(BOARD_URL);
    if(!res.ok) throw new Error("HTTP "+res.status);

    const j = await res.json();
    rawJson = j;

    colorByOlt = new Map();
    buildFiltersFromJson(j);
    applyFiltersAndRender();

  } catch(err){
    console.error(err);
    alert("Load error: " + err.message);
  } finally {
    setLoading(false);
  }
}

function setLoading(flag){
  reloadBtn.disabled = flag;
  reloadBtn.textContent = flag ? "Loading..." : "ğŸ”„ Refresh";
}

function buildFiltersFromJson(j){
  const winSet=new Set(), oltSet=new Set(), ponSet=new Set();
  (j.windows||[]).forEach(w=>{
    winSet.add(w.window||'');
    (w.pons||[]).forEach(p=>{
      ponSet.add(p.pon||'');
      oltSet.add(getOltNumberFromPon(p.pon||''));
    });
  });
  populateSelect(windowFilter, ['', ...Array.from(winSet).sort()], "(all)");
  populateSelect(oltFilter, ['', ...Array.from(oltSet).sort((a,b)=>+a-+b)], "(all)");
  populateSelect(ponFilter, ['', ...Array.from(ponSet).sort()], "(all)");
}

function populateSelect(sel, arr, label){
  const prev = sel.value||'';
  sel.innerHTML='';
  const o0=document.createElement('option');
  o0.value=''; o0.textContent=label;
  sel.appendChild(o0);

  arr.filter(x=>x!=='').forEach(v=>{
    const o=document.createElement('option');
    o.value=v; o.textContent=v; sel.appendChild(o);
  });

  if(prev) sel.value = prev;
}

function applyFiltersAndRender(){
  if(!rawJson) return;
  const filtered = applyClientFilters(rawJson);
  const root = transformToHierarchy(filtered);
  renderHybridTree(root);
}

function applyClientFilters(j){
  const wsel=windowFilter.value;
  const oltsel=oltFilter.value;
  const psel=ponFilter.value;
  const term=(searchInput.value||'').trim().toLowerCase();

  const out={windows:[]};

  (j.windows||[]).forEach(win=>{
    if(wsel && win.window !== wsel) return;

    const newWin={window:win.window, pons:[]};

    (win.pons||[]).forEach(p=>{
      if(psel && p.pon !== psel) return;
      if(oltsel && getOltNumberFromPon(p.pon) !== oltsel) return;

      const newLv = (p.levels||[])
          .filter(l=>Array.isArray(l.splitters)&&l.splitters.length>0);

      if(newLv.length===0 && term){
        if(!deepSearchMatch(p, term)) return;
      }

      newWin.pons.push({...p, levels:newLv});
    });

    if(newWin.pons.length>0 || !wsel){
      out.windows.push(newWin);
    }
  });

  return out;
}

function deepSearchMatch(p, term){
  if(!term) return false;
  for(const lvl of (p.levels||[])){
    for(const sp of (lvl.splitters||[])){
      for(const u of (sp.users||[])){
        if(String(u).toLowerCase().includes(term)) return true;
      }
    }
  }
  return false;
}

/* ==========================================
   ğŸ”¥ FIXED: transformToHierarchy()
========================================== */
function transformToHierarchy(j){
  const root = { name:'Merotra Network', type:'network', children:[] };

  (j.windows || []).forEach(win => {

    const winNode = { name: win.window, type:'window', children:[] };

    const oltMap = {};

    (win.pons || []).forEach(p => {

      const meta = parsePonKey(p.pon);
      const levels = (p.levels||[])
        .map(l=>({
          level:l.level,
          splitters:(l.splitters||[]).map(sp=>({
            recordId:sp.recordId||'',
            type:sp.type||'',
            users:(sp.users||[]).map(x=>String(x)),
            total:sp.total || ((sp.users||[]).length || 0)
          }))
        }));

      const ponNode={
        name: p.pon,
        type:'pon',
        meta,
        levels
      };

      const oltNum = String(meta.olt);
      if(!oltMap[oltNum]){
        oltMap[oltNum] = {
          name: "OLT-"+oltNum,
          type:'olt',
          meta:{olt:oltNum},
          children:[]
        };
      }

      oltMap[oltNum].children.push(ponNode);
    });

    /* Sort PONs inside OLT */
    Object.values(oltMap).forEach(oltn=>{
      oltn.children.sort((a,b)=>{
        if(+a.meta.olt !== +b.meta.olt) return +a.meta.olt - +b.meta.olt;
        if(+a.meta.ip  !== +b.meta.ip ) return +a.meta.ip  - +b.meta.ip;
        return +a.meta.port - +b.meta.port;
      });
    });

    /* Sort OLT groups */
    Object.values(oltMap)
      .sort((a,b)=> (+a.meta.olt) - (+b.meta.olt))
      .forEach(olt=> winNode.children.push(olt));

    root.children.push(winNode);
  });
  return root;
}

/* ==========================================
   RENDER (Hybrid) â€” includes FIX for vGap
========================================== */
function renderHybridTree(rootData){
  d3.select('#chart').selectAll('*').remove();

  const chart=document.getElementById('chart');
  const width = chart.clientWidth;
  const height= chart.clientHeight;

  // hybrid tree + level columns
  const treeRoot = d3.hierarchy(rootData);
  const nodeCount = countLeaves(rootData);
  const nodeGap = Math.min(80, Math.max(40, height/(nodeCount+2)));

  const treeLayout = d3.tree().nodeSize([nodeGap, 140]);
  treeLayout(treeRoot);

  const svg = d3.select("#chart")
      .append("svg")
      .attr("width","100%")
      .attr("height","100%");

  const g = svg.append("g").attr("transform","translate(40,40)");

  /* Draw T-R-E-E links */
  g.selectAll(".hwlink")
    .data(treeRoot.links())
    .enter()
    .append("path")
    .attr("class","link")
    .attr("fill","none")
    .attr("stroke","#94a3b8")
    .attr("stroke-width",2)
    .attr("d",d=>`M${d.source.y},${d.source.x} C ${(d.source.y+d.target.y)/2},${d.source.x} ${(d.source.y+d.target.y)/2},${d.target.x} ${d.target.y},${d.target.x}`);

  /* Draw nodes */
  const n = g.selectAll(".hnode")
        .data(treeRoot.descendants())
        .enter().append("g")
        .attr("class","hnode")
        .attr("transform",d=>`translate(${d.y},${d.x})`);

  n.append("circle")
    .attr("r",d=>({
      network:22, window:18, olt:16, pon:14
    }[d.data.type] || 10))
    .attr("fill",d=>{
      if(d.data.type==='network') return '#1e3a8a';
      if(d.data.type==='window') return '#1d4ed8';
      if(d.data.type==='olt') return ensureColorForOlt(d.data.meta.olt);
      if(d.data.type==='pon') return '#0f766e';
      return '#6b7280';
    })
    .attr("stroke","#fff").attr("stroke-width",2);

  n.append("text")
    .attr("x",d=> d.data.type==='network'?0:18)
    .attr("y",4)
    .attr("font-size","12px")
    .attr("font-weight","600")
    .attr("text-anchor",d=> d.data.type==='network'? "middle":"start")
    .text(d=>d.data.name);


  /* DRAW SPLITTER COLUMNS */
  const ponNodes = treeRoot.descendants().filter(n=>n.data.type==='pon');
  const levelColWidth = 220;
  const ponColGap = 140;

  const splitterPos=[];

  ponNodes.forEach(ponN=>{
    const p=ponN.data;
    if(!(p.levels||[]).length) return;

    const baseX = ponN.y;
    const baseY = ponN.x;

    p.levels.forEach((lvl, i)=>{
      const colX = baseX + ponColGap + i*levelColWidth;
      const sList=lvl.splitters||[];
      const count=sList.length||1;

      /* DYNAMIC spacing â€” FIXED */
      const baseGap=48;
      const vGap = baseGap + (count-1)*14;

      const totalH=(count-1)*vGap;
      const startY=baseY - totalH/2;

      sList.forEach((sp,si)=>{
        splitterPos.push({
          pon:p.name,
          level:lvl.level,
          x:colX,
          y:startY + si*vGap,
          data:sp,
          color:ensureColorForOlt(p.meta.olt)
        });
      });
    });
  });

  const sg = g.append("g");

  sg.selectAll(".splitter")
    .data(splitterPos)
    .enter()
    .append("g")
    .attr("class","splitter")
    .attr("transform",d=>`translate(${d.x},${d.y})`)
    .on("mousemove",(ev,d)=>showTooltip(ev,{type:'splitter', name:d.data.type, total:d.data.total}))
    .on("mouseout",hideTooltip)
    .on("click",(ev,d)=>openPopup(d.data,d.pon,findWindowForPon(d.pon)))
    .each(function(d){
      const g2=d3.select(this);
      g2.append("circle")
        .attr("r",12)
        .attr("fill","#10b981")
        .attr("stroke","#fff")
        .attr("stroke-width",2);

      g2.append("text")
        .attr("x",18).attr("y",4)
        .attr("font-size","11px")
        .text(`${d.data.type} (${d.data.total})`);

      if(d.data.recordId){
        g2.append("text")
          .attr("y",22)
          .attr("font-size","10px")
          .attr("text-anchor","middle")
          .attr("fill","#64748b")
          .text(d.data.recordId);
      }
    });

  /* LINKS: PON â†’ level1 */
  ponNodes.forEach(ponN=>{
    const p=ponN.data;
    const pX=ponN.y, pY=ponN.x;
    const lvl1 = splitterPos.filter(x=>x.pon===p.name && x.level===p.levels[0].level);

    lvl1.forEach(ch=>{
      g.append("path")
        .attr("d",bezier({x:pX,y:pY},{x:ch.x,y:ch.y}))
        .attr("stroke",ensureColorForOlt(p.meta.olt))
        .attr("stroke-width",2)
        .attr("fill","none");
    });
  });

  /* LINKS: levelN â†’ levelN+1 */
  ponNodes.forEach(ponN=>{
    const p=ponN.data;
    const lv=p.levels||[];
    for(let i=0;i<lv.length-1;i++){
      const L1=lv[i].level;
      const L2=lv[i+1].level;

      const parents=splitterPos.filter(x=>x.pon===p.name && x.level===L1);
      const kids=splitterPos.filter(x=>x.pon===p.name && x.level===L2);

      const parentSets=parents.map(pr=> new Set(pr.data.users.map(normalizeId)));

      kids.forEach(ch=>{
        const cSet=new Set(ch.data.users.map(normalizeId));
        let linked=false;
        for(let pi=0;pi<parents.length;pi++){
          let comm=false;
          for(const u of cSet){ if(parentSets[pi].has(u)){ comm=true; break; }}

          if(comm){
            g.append("path")
              .attr("d",bezier({x:parents[pi].x,y:parents[pi].y},{x:ch.x,y:ch.y}))
              .attr("stroke",ch.color)
              .attr("stroke-width",2)
              .attr("fill","none");
            linked=true;
            break;
          }
        }
      });
    }
  });

  /* ZOOM */
  const zoom=d3.zoom().scaleExtent([0.25,3]).on("zoom",ev=> g.attr("transform",ev.transform));
  svg.call(zoom);

  /* Fit view */
  try{
    const bb=g.node().getBBox();
    const sx=width/(bb.width+100);
    const sy=height/(bb.height+100);
    const s=Math.min(sx,sy,1);
    const tx=-bb.x*s+20;
    const ty=-bb.y*s+20;
    svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity.translate(tx,ty).scale(s));
  }catch(e){}

  applySearchHighlight();
}

function bezier(s,d){
  const mid=(s.x+d.x)/2;
  return `M${s.x},${s.y} C${mid},${s.y} ${mid},${d.y} ${d.x},${d.y}`;
}

function countLeaves(node){
  if(!node.children || node.children.length===0) return 1;
  return node.children.reduce((a,c)=>a+countLeaves(c),0);
}

function findWindowForPon(pon){
  if(!rawJson) return '';
  for(const w of rawJson.windows||[]){
    for(const p of w.pons||[]){
      if(p.pon===pon) return w.window;
    }
  }
  return '';
}

/* ==========================================
   Tooltip + Popup
========================================== */
function showTooltip(ev,d){
  tooltip.innerHTML = `<strong>${d.name}</strong><br>Users: ${d.total}`;
  tooltip.style.left = (ev.pageX+12)+"px";
  tooltip.style.top  = (ev.pageY+8)+"px";
  tooltip.style.opacity=1;
}
function hideTooltip(){ tooltip.style.opacity=0; }

function openPopup(sp,pon,win){
  popupModal.style.display='flex';
  popupTitle.textContent = `${sp.type} â€” Users`;
  popupPath.textContent = `${win} â†’ ${pon} â†’ ${sp.recordId}`;
  popupMeta.innerHTML = `<b>Total users:</b> ${sp.total}`;
  popupUsers.innerHTML =
    `<thead><tr><th>Sr</th><th>User</th></tr></thead><tbody>`+
    sp.users.map((u,i)=>`<tr><td>${i+1}</td><td>${u}</td></tr>`).join('')+
    `</tbody>`;
}

/* ==========================================
   Search highlight
========================================== */
function applySearchHighlight(){
  const term=(searchInput.value||'').trim().toLowerCase();
  const nodes=d3.selectAll("g.splitter");

  if(!term){
    nodes.selectAll("circle").attr("opacity",1).attr("stroke","#fff").attr("stroke-width",2);
    nodes.selectAll("text").attr("opacity",1);
    return;
  }

  nodes.each(function(d){
    const users=d.data.users||[];
    const hit=users.some(u=>String(u).toLowerCase().includes(term));
    const g=d3.select(this);
    if(hit){
      g.select("circle").attr("stroke","#ffb020").attr("stroke-width",4).attr("opacity",1);
      g.selectAll("text").attr("opacity",1).style("font-weight","700");
    } else {
      g.select("circle").attr("opacity",0.25);
      g.selectAll("text").attr("opacity",0.3);
    }
  });
}

/* ==========================================
   Downloads
========================================== */
function downloadCSV(){
  if(popupModal.style.display!=='flex') return;
  const rows=[...popupUsers.querySelectorAll("tr")];
  if(!rows.length) return;

  let csv='';
  rows.forEach(r=>{
    const cols=[...r.querySelectorAll("th,td")]
      .map(c=> `"${c.textContent.replace(/"/g,'""')}"`);
    csv += cols.join(",")+"\n";
  });

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="users.csv"; a.click();
  URL.revokeObjectURL(url);
}

function downloadScreenshot(){
  const svg=document.querySelector("#chart svg");
  if(!svg) return alert("Nothing to save");
  const xml=new XMLSerializer().serializeToString(svg);
  const blob=new Blob([xml],{type:"image/svg+xml"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="merotra-tree.svg"; a.click();
  URL.revokeObjectURL(url);
}

/* ==========================================
   INIT
========================================== */
loadAndRender(false);
window.addEventListener('resize',()=> rawJson && applyFiltersAndRender());

</script>

</body>
</html>
