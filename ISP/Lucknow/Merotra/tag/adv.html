<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåê Merotra ‚Äî PON / Splitter Tree</title>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- External CSS File -->
  <link rel="stylesheet" href="adv.css">
</head>

<body>

  <!-- HEADER -->
  <div class="header">
    <div>
      <div class="header-title">üåê Merotra Network Tree</div>
      <div class="header-sub">Window ‚Üí PON ‚Üí Splitters ‚Üí Users (+ Untagged)</div>
    </div>
    <div class="flex items-center gap-2">
      <button id="controlsBtn" class="btn-secondary btn">Filters</button>
      <button id="reloadBtn" class="btn">Reload</button>
    </div>
  </div>

  <div id="chart"></div>
  <div id="tooltip" class="tooltip"></div>

  <!-- POPUP -->
  <div id="popupModal" class="modal-backdrop">
    <div class="modal-content">

      <div class="flex justify-between items-start mb-2">
        <div>
          <h2 id="popupTitle" class="text-lg font-bold mb-1"></h2>
          <div id="popupPath" class="text-xs text-gray-500"></div>
        </div>
        <button id="popupClose" class="btn-secondary btn text-xs px-2 py-1">Close</button>
      </div>

      <div id="popupMeta" class="text-xs text-gray-600 mb-2 space-y-1"></div>
      <div id="popupLinks" class="mb-2 text-xs"></div>

      <h3 class="text-sm font-semibold mt-3 mb-1">Users</h3>
      <div id="popupUsers" class="user-box"></div>

    </div>
  </div>

  <!-- CONTROLS MODAL -->
  <div id="controlsModal" class="modal-backdrop">
    <div class="controls-modal">
      <h2 class="text-base font-bold mb-3">Filters & View</h2>

      <div class="mb-3">
        <div class="filter-title">Windows</div>
        <div id="windowFilters" class="checkbox-grid"></div>
        <div class="mt-1 text-center">
          <span class="select-all" onclick="selectAll('window')">Select All</span> |
          <span class="select-all" onclick="deselectAll('window')">Deselect All</span>
        </div>
      </div>

      <div class="mb-3">
        <div class="filter-title">PONs</div>
        <div id="ponFilters" class="checkbox-grid long-list"></div>
        <div class="mt-1 text-center">
          <span class="select-all" onclick="selectAll('pon')">Select All</span> |
          <span class="select-all" onclick="deselectAll('pon')">Deselect All</span>
        </div>
      </div>

      <button id="applyFiltersBtn" class="btn w-full mt-1">Apply Filters</button>
      <button id="controlsClose" class="btn-secondary btn w-full mt-2">Close</button>
    </div>
  </div>


  <!-- MAIN SCRIPT -->
  <script>

    /* ---------------- CONFIG ---------------- */

    const API_BASE = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgWoNwxGB6cZdAHMQqMmh9R-uY6NTk56cJT4JE1BQNi4u_VU4-hjmrbr1SjmTu7SY_lFxNiNETKTS5sRHKD8Hrr4Uh1GYAGlmrDRjyfoTGetW786IOjsnIqah5_cVjZEPkbGsnQjKY7GGHpErfeZpXItjvb71iz-b-cH5L7ISw_DqTfJBdn8ieDC99pCWOyZv9mzZkpzmxeJVOfxWLnwvj9QMktqCF3PG6871DG6eAotb-vcbTj5XnAw-YLofKgoccAohOSpCB_gn-XWlI1EwQDtLoohgONwIdSu50jkShz1nQ9Cx4&lib=MM9jfESS3VUQ4bogWcHsjBa_bifldmWHw";

    const BOARD_URL = API_BASE + "&mode=board";

    // ---- MASTER DB URLs ----
    const MASTER_API_MEROTRA = "https://script.google.com/macros/s/AKfycbwEjBWnBLw5S45MdR0yq4Kvuuy5uFC_8a8u0syGpW9Kyq2deGY-MdquN69uF6V51qj3Pw/exec?token=abcd1234";
    const MASTER_API_SUNNY   = "https://script.google.com/macros/s/AKfycbymVJ8_kU4T0WEK5eSQftItoh_sHtmmutjTeuVQDhnMpPdk3dUBxDu5XiuA6tqZ64ZY/exec?token=abcd1234";

    // Headers
    const USER_ID_FIELD     = "Users";
    const USER_NAME_FIELD   = "Name";
    const USER_NUM_FIELD    = "Number";
    const USER_LOC_FIELD    = "Location";
    const USER_STATUS_FIELD = "User status";

    /* ---------------- STATE ---------------- */

    let rawBoard = {};
    let currentTreeData = null;

    const statusMaps = {
      Merotra: {},
      Sunny: {}
    };

    const masterMerged = {};  // <---- MERGED lookup (NEW)

    let filters = {
      windows: [],
      pons: []
    };

    const tooltip = document.getElementById("tooltip");


    /* ---------------- INIT ---------------- */

    document.getElementById("reloadBtn").onclick = () => loadAll(true);
    document.getElementById("controlsBtn").onclick = () => controlsModal.style.display = "flex";
    document.getElementById("controlsClose").onclick = () => controlsModal.style.display = "none";
    document.getElementById("popupClose").onclick = () => popupModal.style.display = "none";
    document.getElementById("applyFiltersBtn").onclick = applyFiltersFromUI;

    window.addEventListener("resize", () => {
      if (currentTreeData) drawTree(currentTreeData);
    });

    loadAll(false);


    /* ---------------- LOAD ALL ---------------- */

    async function loadAll() {
      setLoading(true);

      // Load board
      const bRes = await fetch(BOARD_URL);
      rawBoard = await bRes.json();

      // Load both masters
      await Promise.all([
        loadMaster("Merotra", MASTER_API_MEROTRA),
        loadMaster("Sunny", MASTER_API_SUNNY)
      ]);

      mergeMasterData();  // <---- NEW fix

      setupFiltersFromBoard();

      const filtered = filterBoard(rawBoard);
      const tree = buildHierarchy(filtered);

      currentTreeData = tree;
      drawTree(tree);

      setLoading(false);
    }

    /* ---------------- MASTER LOADING ---------------- */

    async function loadMaster(windowName, url) {
      try {
        const r = await fetch(url);
        const json = await r.json();
        const map = {};

        json.rows.forEach(row => {
          const id = (row[USER_ID_FIELD] || "").toString().trim();
          if (!id) return;

          map[id] = {
            status: row[USER_STATUS_FIELD] || "",
            name: row[USER_NAME_FIELD] || "",
            number: row[USER_NUM_FIELD] || "",
            address: row[USER_LOC_FIELD] || ""
          };
        });

        statusMaps[windowName] = map;

      } catch (e) {
        console.error("Master load failed:", windowName, e);
      }
    }

    /* ----------- MERGED LOOKUP (IMPORTANT FIX) ----------- */

    function mergeMasterData() {
      Object.assign(masterMerged, statusMaps.Merotra);
      Object.assign(masterMerged, statusMaps.Sunny);
    }

    function getUserMeta(id) {
      return masterMerged[id] || {
        name: "",
        number: "",
        address: "",
        status: ""
      };
    }

    /* ---------------- FILTER SETUP ---------------- */

    function setupFiltersFromBoard() {
      const windows = new Set();
      const pons = new Set();

      Object.entries(rawBoard).forEach(([pon, winObj]) => {
        pons.add(pon);
        Object.keys(winObj).forEach(w => windows.add(w));
      });

      filters.windows = [...windows];
      filters.pons = [...pons];

      // populate UI
      populateFilterUI("windowFilters", windows);
      populateFilterUI("ponFilters", pons);
    }

    function populateFilterUI(id, arr) {
      const box = document.getElementById(id);
      box.innerHTML = "";
      [...arr].sort().forEach(v => {
        box.innerHTML += `
          <div class="checkbox-item">
            <label><input type="checkbox" value="${v}" checked> <span>${v}</span></label>
          </div>`;
      });
    }

    function selectAll(type) {
      document.querySelectorAll(`#${type}Filters input`).forEach(c => c.checked = true);
    }
    function deselectAll(type) {
      document.querySelectorAll(`#${type}Filters input`).forEach(c => c.checked = false);
    }

    function applyFiltersFromUI() {
      filters.windows = [...document.querySelectorAll("#windowFilters input:checked")].map(i => i.value);
      filters.pons = [...document.querySelectorAll("#ponFilters input:checked")].map(i => i.value);

      controlsModal.style.display = "none";

      const f = filterBoard(rawBoard);
      const t = buildHierarchy(f);
      currentTreeData = t;
      drawTree(t);
    }

    function filterBoard(board) {
      const out = {};
      Object.entries(board).forEach(([pon, winObj]) => {
        if (!filters.pons.includes(pon)) return;

        const newWins = {};
        Object.entries(winObj).forEach(([win, splits]) => {
          if (filters.windows.includes(win)) newWins[win] = splits;
        });

        if (Object.keys(newWins).length) out[pon] = newWins;
      });
      return out;
    }

    /* ---------------- TREE BUILDING ---------------- */

    function buildHierarchy(board) {

      const root = {
        nodeType: "root",
        name: "üåê Merotra Network",
        children: []
      };

      const winMap = {};

      Object.entries(board).forEach(([pon, winObj]) => {
        Object.entries(winObj).forEach(([win, splitObj]) => {

          // Window Node
          if (!winMap[win]) {
            const wn = { nodeType: "window", name: "ü™ü " + win, rawWindow: win, children: [] };
            winMap[win] = wn;
            root.children.push(wn);
          }

          const winNode = winMap[win];

          const ponNode = {
            nodeType: "pon",
            rawPon: pon,
            name: "üîå " + pon,
            window: win,
            children: []
          };

          const entries = [];

          Object.entries(splitObj).forEach(([split, info]) => {
            const users = info.users || [];
            const ids = users.map(u => u.id.toString());
            entries.push({
              splitter: split,
              info,
              users,
              userIds: ids,
              userSet: new Set(ids)
            });
          });

          if (entries.length === 0) {
            winNode.children.push(ponNode);
            return;
          }

          // Sort by size
          entries.sort((a,b)=>b.userIds.length - a.userIds.length);

          const nodes = entries.map(e => ({
            entry: e,
            node: makeSplitterNode(e, pon, win)
          }));

          const primary = nodes[0].node;
          ponNode.children.push(primary);

          // subset linking
          for (let i=1;i<nodes.length;i++){
            const child = nodes[i];
            let parent = primary;

            for (let j=i-1;j>=0;j--){
              if (isSubset(child.entry.userSet, nodes[j].entry.userSet)) {
                parent = nodes[j].node;
                break;
              }
            }

            parent.children.push(child.node);
          }

          // leftover users
          nodes.forEach(n => {
            if (!n.node.children.length) return;

            const parentSet = new Set(n.node.userIds);
            const childSet = new Set();

            n.node.children.forEach(c =>
              c.userIds.forEach(id => childSet.add(id))
            );

            const left = [...parentSet].filter(x => !childSet.has(x));

            if (left.length) {
              n.node.children.push({
                nodeType: "untagged",
                name: "‚¨ú Other ("+left.length+")",
                rawSplitter: "Other",
                window: win,
                pon,
                users: left.map(x => ({id:x,offline:false})),
                userIds: left,
                children:[]
              });
            }
          });

          winNode.children.push(ponNode);
        });
      });

      return root;
    }

    function makeSplitterNode(entry, pon, win){
      return {
        nodeType: "splitter",
        name: emoji(entry.splitter) + " " + entry.splitter + " ("+entry.userIds.length+")",
        rawSplitter: entry.splitter,
        pon, window: win,
        users: entry.users,
        userIds: entry.userIds,
        tag: entry.info.tag || "",
        location: entry.info.location || "",
        jcPic: entry.info.jcPic || "",
        polePic: entry.info.polePic || "",
        children:[]
      };
    }

    function emoji(s){
      s = s.toLowerCase();
      if (s.includes("link")) return "üîó";
      if (s.includes("16")) return "üî∫";
      if (s.includes("8")) return "üîµ";
      if (s.includes("4")) return "üü•";
      if (s.includes("2")) return "üü©";
      return "‚¨ú";
    }

    function isSubset(a,b){
      for (let v of a) if (!b.has(v)) return false;
      return true;
    }

    /* ---------------- DRAW TREE ---------------- */

    function drawTree(data) {
      d3.select("#chart").select("svg").remove();

      const width = chart.clientWidth;
      const height = chart.clientHeight;

      const dx = 80;
      const dy = width > 900 ? 260 : 200;

      const tree = d3.tree().nodeSize([dx,dy]);
      const root = d3.hierarchy(data, d=>d.children);

      tree(root);

      const svg = d3.select("#chart")
        .append("svg")
        .attr("width",width)
        .attr("height",height);

      const zoom = d3.zoom().scaleExtent([0.4,3]).on("zoom",e=>g.attr("transform",e.transform));
      svg.call(zoom);

      const g = svg.append("g").attr("transform","translate(80,60)");

      // links
      g.selectAll("path")
        .data(root.links())
        .enter()
        .append("path")
        .attr("d",d3.linkHorizontal().x(d=>d.y).y(d=>d.x))
        .attr("stroke","#94a3b8")
        .attr("fill","none")
        .attr("stroke-width",2);

      // nodes
      const node = g.selectAll(".node")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("transform",d=>`translate(${d.y},${d.x})`);

      node.append("circle")
        .attr("r",d=>d.data.nodeType=="root"?24:d.data.nodeType=="window"?20:d.data.nodeType=="pon"?18:d.data.nodeType=="splitter"?14:10)
        .attr("fill",d=>colorNode(d.data))
        .attr("stroke","#fff")
        .attr("stroke-width",2)
        .on("mousemove",handleHover)
        .on("mouseout",()=>tooltip.style.opacity=0)
        .on("click",handleClick);

      node.append("text")
        .attr("dy","0.32em")
        .attr("x",d=>d.children && d.depth>0?-20:20)
        .attr("text-anchor",d=>d.children?"end":"start")
        .style("font-size","11px")
        .style("font-weight",d=>d.data.nodeType=="root"?700:500)
        .text(d=>d.data.name);

      fit(svg,g,zoom);
    }

    function colorNode(d){
      if (d.nodeType=="root") return "#1e3a8a";
      if (d.nodeType=="window") return "#1d4ed8";
      if (d.nodeType=="pon") return "#0f766e";
      if (d.nodeType=="untagged") return "#6b7280";

      if (d.tag && d.tag.includes("‚ùå")) return "#ef4444";
      return "#10b981";
    }

    function fit(svg,g,zoom){
      const b = g.node().getBBox();
      const w = chart.clientWidth;
      const h = chart.clientHeight;

      const scale = Math.min(2,Math.max(0.4,Math.min(w/(b.width+200),h/(b.height+200))));
      const tx = -(b.x)*scale+40;
      const ty = -(b.y)*scale+40;

      svg.transition().duration(600)
        .call(zoom.transform,d3.zoomIdentity.translate(tx,ty).scale(scale));
    }

    /* ---------------- HOVER ---------------- */

    function handleHover(event,d){
      const t = d.data;

      let html = `<strong>${t.name}</strong><br/>`;

      if (t.nodeType=="pon"){
        html += `PON: ${t.rawPon}`;
      }
      else if (t.nodeType=="splitter" || t.nodeType=="untagged"){
        html += `Window: ${t.window}<br/>PON: ${t.pon}<br/>Users: ${t.userIds.length}`;
        if (t.tag) html += `<br/>Tag: ${t.tag}`;
      }

      tooltip.innerHTML = html;
      tooltip.style.left = (event.pageX+15)+"px";
      tooltip.style.top  = (event.pageY+10)+"px";
      tooltip.style.opacity = 1;
    }

    /* ---------------- POPUP ---------------- */

    function handleClick(event,d){
      const t = d.data;
      if (!(t.nodeType=="splitter" || t.nodeType=="untagged")) return;

      popupModal.style.display = "flex";

      document.getElementById("popupTitle").textContent = `${t.rawSplitter} ‚Äî Users`;
      document.getElementById("popupPath").textContent = `${t.window} ‚Üí ${t.pon} ‚Üí ${t.rawSplitter}`;

      document.getElementById("popupMeta").innerHTML = `
        <div><strong>Window:</strong> ${t.window}</div>
        <div><strong>PON:</strong> ${t.pon}</div>
        <div><strong>Splitter:</strong> ${t.rawSplitter}</div>
        <div><strong>Total:</strong> ${t.userIds.length}</div>
        <div><strong>Tag:</strong> ${t.tag || "-"}</div>
      `;

      let links = "";
      if (t.location) links += `<span class="link-btn" onclick="openLink('${t.location}')">üìç Location</span>`;
      if (t.jcPic) links += `<span class="link-btn" onclick="openLink('${t.jcPic}')">üì∏ JC Pic</span>`;
      if (t.polePic) links += `<span class="link-btn" onclick="openLink('${t.polePic}')">ü™µ Pole Pic</span>`;
      document.getElementById("popupLinks").innerHTML = links;

      const box = document.getElementById("popupUsers");
      box.innerHTML="";

      t.users.forEach((u,i)=>{
        const id = u.id.toString();
        const meta = getUserMeta(id);

        box.innerHTML += `
          <div class="user-row">
            <div><span class="idx">${i+1}.</span> <span class="uid">${id}</span></div>
            <div class="text-right">
              <div>${meta.name || ""}</div>
              <div>${meta.number || ""}</div>
              <div>${meta.status || ""}</div>
              <div class="addr">${meta.address || ""}</div>
            </div>
          </div>
        `;
      });
    }

    window.openLink = (url)=>window.open(url,"_blank");

    function setLoading(f){
      const b = document.getElementById("reloadBtn");
      b.textContent = f?"Loading...":"Reload";
      b.disabled = f;
    }

  </script>

</body>
</html>
