<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>FTTH Board Tree</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="adv.css" />

    <!-- D3 library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>

<!-- ---------------------------------------------------------
     TOP HEADER
--------------------------------------------------------- -->
<div class="topbar">
    <div class="title">üì° FTTH Board View</div>

    <div class="controls">
        <button class="btn-secondary" id="openFilters">Filters</button>
        <button class="btn" id="resetView">Reset View</button>
    </div>
</div>

<!-- ---------------------------------------------------------
     SEARCH FLOAT BUTTON
--------------------------------------------------------- -->
<div class="searchToggle" id="searchToggle">üîç</div>

<!-- ---------------------------------------------------------
     SEARCH PANEL
--------------------------------------------------------- -->
<div class="searchPanel" id="searchPanel">
    <input id="searchInput"
           placeholder="Search User ID..."
           style="width:100%;padding:6px;border:1px solid #ddd;border-radius:6px;font-size:14px;margin-bottom:6px;">
    <button id="runSearch" class="btn" style="width:100%;margin-top:4px;">Search</button>
</div>

<!-- ---------------------------------------------------------
     POPUP ‚Äî splitter details
--------------------------------------------------------- -->
<div class="popup-backdrop" id="popupBg">
    <div class="modal-content">
        <h3 id="popupTitle" style="margin-top:0;font-size:1rem;font-weight:700;"></h3>
        <div id="popupBody"></div>

        <div class="download-btns">
            <button class="download-btn btn-shot" id="downloadImage">Download PNG</button>
            <button class="download-btn btn-csv" id="downloadCSV">Download CSV</button>
        </div>
    </div>
</div>

<!-- ---------------------------------------------------------
     INFO CARD (bottom-left)
--------------------------------------------------------- -->
<div class="info-card" id="infoCard"></div>

<!-- ---------------------------------------------------------
     FILTER PANEL
--------------------------------------------------------- -->
<div class="controls-backdrop" id="filterBg" style="display:none;">
    <div class="controls-modal">
        <h3 style="margin-top:0;font-size:1rem;">Filters</h3>

        <!-- Window Filter -->
        <div class="filter-title">Select Window</div>
        <div class="checkbox-grid" id="windowFilter"></div>

        <!-- PON Filter -->
        <div class="filter-title" style="margin-top:10px;">Select PON</div>
        <div class="checkbox-grid pon-grid" id="ponFilter"></div>

        <!-- Splitter Filter -->
        <div class="filter-title" style="margin-top:10px;">Select Splitter</div>
        <div class="checkbox-grid pon-grid" id="splitterFilter"></div>

        <div style="display:flex;justify-content:end;margin-top:12px;gap:8px;">
            <button class="btn-secondary" id="closeFilters">Cancel</button>
            <button class="btn" id="applyFilters">Apply</button>
        </div>
    </div>
</div>

<!-- ---------------------------------------------------------
     MAIN SVG TREE
--------------------------------------------------------- -->
<div id="chartWrap">
    <svg id="chartSVG"></svg>
</div>


<!-- ---------------------------------------------------------
     TREE SCRIPT
--------------------------------------------------------- -->
<script>
/* -----------------------------------------------------------
   1) LOAD JSON DATA
----------------------------------------------------------- */
const DATA_URL = "https://script.google.com/macros/s/AKfycbzItUueYIqcUuCn2cDaTTrWIF0LiilUxOXhhL-4b4D9aUlEo8Ov9pasR44d6JSM3h1t/exec?mode=board";

let rawData = null;
let flatSplitters = [];
let activeWindowFilter = [];
let activePONFilter = [];
let activeSplitterFilter = [];

let svg = d3.select("#chartSVG");
let gLinks = svg.append("g");
let gNodes = svg.append("g");
let gGuides = svg.append("g");


/* -----------------------------------------------------------
   2) RESPONSIVE RESIZE
----------------------------------------------------------- */
let W = 0, H = 0;
function resize() {
    const wrap = document.getElementById("chartWrap");
    W = wrap.clientWidth;
    H = wrap.clientHeight;
    svg.attr("width", W).attr("height", H);
}
window.addEventListener("resize", resize);


/* -----------------------------------------------------------
   3) FETCH JSON + INIT
----------------------------------------------------------- */
async function init() {
    resize();

    const res = await fetch(DATA_URL);
    rawData = await res.json();

    flattenData();
    buildFilters();
    drawTree();
}
init();


/* -----------------------------------------------------------
   4) FLATTEN DATA (window ‚Üí pons ‚Üí levels ‚Üí splitters)
----------------------------------------------------------- */
function flattenData() {
    flatSplitters = [];

    rawData.windows.forEach(w => {
        w.pons.forEach(p => {
            p.levels.forEach(lv => {
                lv.splitters.forEach(sp => {
                    flatSplitters.push({
                        window: w.window,
                        pon: p.pon,
                        level: lv.level,
                        recordId: sp.recordId,
                        type: sp.type,
                        users: sp.users,
                        total: sp.total
                    });
                });
            });
        });
    });
}


/* -----------------------------------------------------------
   5) BUILD FILTER CHECKBOXES
----------------------------------------------------------- */
function buildFilters() {
    const windowFilter = document.getElementById("windowFilter");
    const ponFilter = document.getElementById("ponFilter");
    const splitterFilter = document.getElementById("splitterFilter");

    windowFilter.innerHTML = "";
    ponFilter.innerHTML = "";
    splitterFilter.innerHTML = "";

    // Windows
    const windows = [...new Set(rawData.windows.map(w => w.window))];
    windows.forEach(w => {
        windowFilter.innerHTML += `
            <div class="checkbox-item">
                <label>
                    <input type="checkbox" value="${w}" class="wFilter">
                    ${w}
                </label>
            </div>`;
    });

    // PONs
    const pons = flatSplitters.map(x => x.pon);
    const uniquePons = [...new Set(pons)];
    uniquePons.forEach(p => {
        ponFilter.innerHTML += `
            <div class="checkbox-item">
                <label>
                    <input type="checkbox" value="${p}" class="pFilter">
                    ${p}
                </label>
            </div>`;
    });

    // Splitters
    flatSplitters.forEach(sp => {
        splitterFilter.innerHTML += `
            <div class="checkbox-item">
                <label>
                    <input type="checkbox" value="${sp.recordId}" class="sFilter">
                    ${sp.recordId || '(empty)'}
                </label>
            </div>`;
    });
}


/* -----------------------------------------------------------
   6) DRAW TREE (WINDOW ‚Üí PON ‚Üí LEVELS ‚Üí SPLITTERS)
----------------------------------------------------------- */
function drawTree() {
    svg.selectAll("*").remove();
    gLinks = svg.append("g");
    gNodes = svg.append("g");
    gGuides = svg.append("g");

    // Layout settings
    const colGap = 240;
    const rowGap = 60;

    let xStart = 80;
    let windowY = 80;

    rawData.windows.forEach(w => {
        const winNode = { x: xStart, y: windowY, label: w.window };
        drawNode(winNode, "window");

        let ponY = windowY + 120;
        w.pons.forEach(p => {
            const ponNode = { x: xStart + colGap, y: ponY, label: p.pon };
            drawNode(ponNode, "pon");
            drawLink(winNode, ponNode, "#6b7280");

            // Levels
            const maxLevel = Math.max(...p.levels.map(l => l.level));
            let levelX = xStart + colGap * 2;

            for (let L = 1; L <= maxLevel; L++) {
                const Ldata = p.levels.find(x => x.level === L);
                if (!Ldata) continue;

                const sList = Ldata.splitters;

                sList.forEach((sp, idx) => {
                    const spNode = {
                        x: levelX,
                        y: ponY + idx * rowGap,
                        label: sp.recordId || "(empty)",
                        spData: sp
                    };

                    drawNode(spNode, "splitter");

                    // Connect to parent (pon or previous level)
                    if (L === 1) {
                        drawLink(ponNode, spNode);
                    } else {
                        const prev = p.levels.find(x => x.level === (L - 1));
                        if (prev) {
                            let linked = false;

                            prev.splitters.forEach(par => {
                                const overlap = par.users.some(u => sp.users.includes(u));
                                if (overlap) {
                                    const parentNode = {
                                        x: levelX - colGap,
                                        y: spNode.y, // approximate center alignment
                                        label: par.recordId,
                                        spData: par
                                    };
                                    drawLink(parentNode, spNode);
                                    linked = true;
                                }
                            });
                        }
                    }
                });

                levelX += colGap;
            }

            ponY += (p.levels[0].splitters.length + 1.5) * rowGap;
        });

        windowY = ponY + 120;
    });
}


/* -----------------------------------------------------------
   7) DRAW NODE
----------------------------------------------------------- */
function drawNode(node, type) {
    const nodeGroup = gNodes.append("g").attr("transform", `translate(${node.x},${node.y})`);

    const color = (type === "window") ? "#0ea5e9"
                : (type === "pon") ? "#2563eb"
                : "#10b981";

    nodeGroup.append("circle")
        .attr("r", 18)
        .attr("fill", color)
        .attr("class", "node-circle")
        .on("click", () => showInfo(node));

    nodeGroup.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", 4)
        .attr("class", "node-text")
        .text(node.label);
}


/* -----------------------------------------------------------
   8) DRAW LINK
----------------------------------------------------------- */
function drawLink(a, b, color = null) {
    gLinks.append("line")
        .attr("x1", a.x)
        .attr("y1", a.y)
        .attr("x2", b.x)
        .attr("y2", b.y)
        .attr("stroke", color || "#9ca3af")
        .attr("class", "link");
}


/* -----------------------------------------------------------
   9) SHOW INFO POPUP
----------------------------------------------------------- */
function showInfo(node) {
    const card = document.getElementById("infoCard");

    if (!node.spData) {
        card.innerHTML = `<div class="info-row"><b>${node.label}</b></div>`;
        card.style.display = "block";
        return;
    }

    const sp = node.spData;
    card.innerHTML = `
        <div class="info-row"><b>Record ID:</b> ${sp.recordId}</div>
        <div class="info-row"><b>Type:</b> ${sp.type}</div>
        <div class="info-row"><b>Total Users:</b> ${sp.total}</div>
        <div class="info-row"><b>Users:</b> ${sp.users.join(", ")}</div>
    `;

    card.style.display = "block";
}


/* -----------------------------------------------------------
   10) SEARCH USER HIGHLIGHT
----------------------------------------------------------- */
document.getElementById("runSearch").addEventListener("click", () => {
    const id = document.getElementById("searchInput").value.trim();
    if (!id) return;

    d3.selectAll(".node-circle").classed("highlight", false);

    flatSplitters.forEach(sp => {
        if (sp.users.includes(id)) {
            const match = d3.selectAll("text")
                .filter(function() { return this.textContent == sp.recordId; })
                .node();

            if (match) {
                const group = match.parentNode;
                d3.select(group).select("circle").classed("highlight", true);
            }
        }
    });
});


/* -----------------------------------------------------------
   11) TOGGLES
----------------------------------------------------------- */
document.getElementById("searchToggle").onclick = () => {
    const p = document.getElementById("searchPanel");
    p.style.display = (p.style.display === "block") ? "none" : "block";
};

document.getElementById("openFilters").onclick = () => {
    document.getElementById("filterBg").style.display = "flex";
};

document.getElementById("closeFilters").onclick = () => {
    document.getElementById("filterBg").style.display = "none";
};

document.getElementById("resetView").onclick = () => {
    location.reload();
};
</script>

</body>
</html>
