<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåê Merotra ‚Äî PON / Splitter Tree</title>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(135deg,#f0f9ff,#e0f2fe);
      color: #111827;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      position: sticky;
      top: 0;
      z-index: 30;
    }
    .header-title {
      font-weight: 800;
      font-size: 1.15rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-sub {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 600;
    }
    #chart {
      width: 100%;
      height: calc(100vh - 60px);
    }
    .btn {
      background: #2563eb;
      color: #fff;
      font-weight: 600;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-small {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
      font-weight: 500;
    }
    .btn-small-primary {
      background: #16a34a;
      color: #fff;
    }
    .btn-small-warning {
      background: #f59e0b;
      color: #111827;
    }
    .tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(15,23,42,0.9);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      opacity: 0;
      transition: opacity .15s;
      z-index: 50;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    .modal-content {
      background: rgba(255,255,255,0.98);
      border-radius: 14px;
      padding: 16px 18px;
      max-width: 520px;
      width: 92%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(15,23,42,0.2);
    }
    .user-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 4px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.85rem;
    }
    .user-row:last-child {
      border-bottom: none;
    }
    .user-row.offline {
      background: rgba(248,113,113,0.08);
    }
    .user-main {
      font-size: 0.85rem;
    }
    .user-meta {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 2px;
    }
    .controls-modal {
      background: rgba(255,255,255,0.98);
      border-radius: 14px;
      padding: 16px 18px;
      max-width: 520px;
      width: 92%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(15,23,42,0.2);
    }
    .filter-title {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(120px,1fr));
      gap: 4px 8px;
      font-size: 0.85rem;
    }
    .checkbox-item label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 6px;
    }
    .checkbox-item label:hover {
      background: #e5e7eb;
    }
    .select-all {
      font-size: 0.8rem;
      color: #2563eb;
      font-weight: 600;
      cursor: pointer;
      text-decoration: underline;
    }
    .link-btn {
      font-size: 0.8rem;
      color: #2563eb;
      text-decoration: underline;
      cursor: pointer;
      margin-right: 8px;
    }
    .tag-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5f9e7;
      font-size: 0.7rem;
      gap: 4px;
    }
    .gray-pill {
      background: #e5e7eb;
    }
    .blink-red {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%,100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
  </style>
</head>
<body>

  <div class="header">
    <div>
      <div class="header-title">
        <span>üåê Merotra Network Tree</span>
      </div>
      <div class="header-sub">Window ‚Üí PON ‚Üí Splitters ‚Üí Users (+ Untagged branch)</div>
    </div>
    <div class="flex items-center gap-2">
      <button id="controlsBtn" class="btn-secondary btn">Filters</button>
      <button id="reloadBtn" class="btn">Reload</button>
    </div>
  </div>

  <div id="chart"></div>
  <div id="tooltip" class="tooltip"></div>

  <!-- POPUP: Splitter / Untagged -->
  <div id="popupModal" class="modal-backdrop">
    <div class="modal-content" id="popupContent">
      <div class="flex justify-between items-start mb-2">
        <div>
          <h2 id="popupTitle" class="text-lg font-bold mb-1"></h2>
          <div id="popupPath" class="text-xs text-gray-500"></div>
        </div>
        <button id="popupClose" class="btn-secondary btn text-xs px-2 py-1">Close</button>
      </div>

      <div class="text-xs text-gray-600 mb-2 space-y-1" id="popupMeta">
        <!-- filled by JS -->
      </div>

      <div class="mb-2 text-xs" id="popupLinks">
        <!-- location / pics -->
      </div>

      <div class="flex gap-2 mb-2 text-xs">
        <button id="popupScreenshot" class="btn-small btn-small-primary">üì∏ Screenshot</button>
        <button id="popupCsv" class="btn-small btn-small-warning">üìä CSV</button>
      </div>

      <h3 class="text-sm font-semibold mt-2 mb-1">Users</h3>
      <div id="popupUsers" style="max-height: 260px; overflow-y:auto; border-radius:8px; border:1px solid #e5e7eb;"></div>
    </div>
  </div>

  <!-- CONTROLS MODAL -->
  <div id="controlsModal" class="modal-backdrop">
    <div class="controls-modal">
      <h2 class="text-base font-bold mb-3">Filters & View</h2>

      <div class="mb-3">
        <div class="filter-title">Windows</div>
        <div id="windowFilters" class="checkbox-grid"></div>
        <div class="mt-1 text-center">
          <span class="select-all" onclick="selectAll('window')">Select All</span> |
          <span class="select-all" onclick="deselectAll('window')">Deselect All</span>
        </div>
      </div>

      <div class="mb-3">
        <div class="filter-title">PONs</div>
        <div id="ponFilters" class="checkbox-grid" style="max-height:180px;overflow-y:auto;"></div>
        <div class="mt-1 text-center">
          <span class="select-all" onclick="selectAll('pon')">Select All</span> |
          <span class="select-all" onclick="deselectAll('pon')">Deselect All</span>
        </div>
      </div>

      <button id="applyFiltersBtn" class="btn w-full mt-1">Apply Filters</button>
      <button id="controlsClose" class="btn-secondary btn w-full mt-2">Close</button>
    </div>
  </div>

  <script>
    // -------------------- CONFIG --------------------

    // Same API_BASE jo aap pehle use kar rahe the (board/data)
    const API_BASE = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgWoNwxGB6cZdAHMQqMmh9R-uY6NTk56cJT4JE1BQNi4u_VU4-hjmrbr1SjmTu7SY_lFxNiNETKTS5sRHKD8Hrr4Uh1GYAGlmrDRjyfoTGetW786IOjsnIqah5_cVjZEPkbGsnQjKY7GGHpErfeZpXItjvb71iz-b-cH5L7ISw_DqTfJBdn8ieDC99pCWOyZv9mzZkpzmxeJVOfxWLnwvj9QMktqCF3PG6871DG6eAotb-vcbTj5XnAw-YLofKgoccAohOSpCB_gn-XWlI1EwQDtLoohgONwIdSu50jkShz1nQ9Cx4&lib=MM9jfESS3VUQ4bogWcHsjBa_bifldmWHw";

    const BOARD_URL = API_BASE + "&mode=board";

    // TheMaster DB URLs (token = abcd1234)
    const MASTER_API_MEROTRA = "https://script.google.com/macros/s/AKfycbwEjBWnBLw5S45MdR0yq4Kvuuy5uFC_8a8u0syGpW9Kyq2deGY-MdquN69uF6V51qj3Pw/exec?token=abcd1234";
    const MASTER_API_SUNNY   = "https://script.google.com/macros/s/AKfycbymVJ8_kU4T0WEK5eSQftItoh_sHtmmutjTeuVQDhnMpPdk3dUBxDu5XiuA6tqZ64ZY/exec?token=abcd1234";

    // TheMaster headers (row 1 text)
    const USER_ID_FIELD      = "Users";        // Column N
    const USER_NAME_FIELD    = "Name";         // Column O
    const USER_NUMBER_FIELD  = "Number";       // Column P
    const USER_LOC_FIELD     = "Location";     // Column Q
    const USER_STATUS_FIELD  = "User status";  // Column AF

    // --------------- GLOBAL STATE ----------------

    const tooltip = document.getElementById("tooltip");
    const popupModal = document.getElementById("popupModal");
    const controlsModal = document.getElementById("controlsModal");

    let rawBoard = {};            // BOARD_URL se raw JSON
    let svg, g, treeLayout, root;
    let currentTreeData = null;

    let filters = {
      windows: [],
      pons: []
    };

    // window name -> { userId -> { status,name,number,location } }
    const statusMaps = {
      Merotra: {},
      Sunny: {}
    };

    let currentClickNode = null;

    // --------------- INIT ----------------

    document.getElementById("reloadBtn").addEventListener("click", () => {
      loadAll(true);
    });
    document.getElementById("controlsBtn").addEventListener("click", () => {
      controlsModal.style.display = "flex";
    });
    document.getElementById("controlsClose").addEventListener("click", () => {
      controlsModal.style.display = "none";
    });
    document.getElementById("popupClose").addEventListener("click", () => {
      popupModal.style.display = "none";
    });
    document.getElementById("applyFiltersBtn").addEventListener("click", applyFiltersFromUI);

    document.getElementById("popupScreenshot").addEventListener("click", downloadPopupScreenshot);
    document.getElementById("popupCsv").addEventListener("click", downloadPopupCsv);

    window.addEventListener("resize", () => {
      if (currentTreeData) drawTree(currentTreeData);
    });

    // Page load
    loadAll(false);

    async function loadAll(showToast){
      try {
        setLoading(true);
        // 1) board
        const bRes = await fetch(BOARD_URL);
        rawBoard = await bRes.json();

        // 2) status DBs
        await Promise.all([
          loadStatusesForWindow("Merotra", MASTER_API_MEROTRA),
          MASTER_API_SUNNY ? loadStatusesForWindow("Sunny", MASTER_API_SUNNY) : Promise.resolve()
        ]);

        // 3) filters setup
        setupFiltersFromBoard();

        // 4) build + draw
        const filtered = filterBoard(rawBoard, filters);
        const treeData = buildHierarchy(filtered);
        currentTreeData = treeData;
        drawTree(treeData);

      } catch(e){
        console.error(e);
        alert("Error loading data: " + e);
      } finally {
        setLoading(false);
      }
    }

    function setLoading(flag){
      const btn = document.getElementById("reloadBtn");
      btn.textContent = flag ? "Loading..." : "Reload";
      btn.disabled = flag;
    }

    // --------------- STATUS MAP (TheMaster) ----------------

    async function loadStatusesForWindow(windowName, apiUrl){
      if (!apiUrl) return;
      try {
        const res = await fetch(apiUrl);
        const json = await res.json();
        if (!json || !Array.isArray(json.rows)) return;

        const m = {};
        json.rows.forEach(row => {
          const id = (row[USER_ID_FIELD] ?? "").toString().trim();
          if (!id) return;
          m[id] = {
            status:   (row[USER_STATUS_FIELD] ?? "").toString().trim(),
            name:     (row[USER_NAME_FIELD] ?? "").toString().trim(),
            number:   (row[USER_NUMBER_FIELD] ?? "").toString().trim(),
            location: (row[USER_LOC_FIELD] ?? "").toString().trim()
          };
        });
        statusMaps[windowName] = m;
      } catch(e){
        console.error("Status load failed for", windowName, e);
      }
    }

    // --------------- FILTER SETUP ----------------

    function setupFiltersFromBoard(){
      const windowSet = new Set();
      const ponSet = new Set();

      Object.entries(rawBoard).forEach(([pon, winObj]) => {
        ponSet.add(pon);
        Object.keys(winObj || {}).forEach(w => windowSet.add(w));
      });

      filters.windows = Array.from(windowSet);
      filters.pons = Array.from(ponSet);

      const winDiv = document.getElementById("windowFilters");
      const ponDiv = document.getElementById("ponFilters");
      winDiv.innerHTML = "";
      ponDiv.innerHTML = "";

      Array.from(windowSet).sort().forEach(w => {
        const el = document.createElement("div");
        el.className = "checkbox-item";
        el.innerHTML = `
          <label>
            <input type="checkbox" value="${w}" checked>
            <span>${w}</span>
          </label>`;
        winDiv.appendChild(el);
      });

      Array.from(ponSet).sort().forEach(p => {
        const el = document.createElement("div");
        el.className = "checkbox-item";
        el.innerHTML = `
          <label>
            <input type="checkbox" value="${p}" checked>
            <span>${p}</span>
          </label>`;
        ponDiv.appendChild(el);
      });
    }

    function selectAll(type){
      document.querySelectorAll(`#${type}Filters input[type="checkbox"]`)
        .forEach(ch => ch.checked = true);
    }

    function deselectAll(type){
      document.querySelectorAll(`#${type}Filters input[type="checkbox"]`)
        .forEach(ch => ch.checked = false);
    }

    function applyFiltersFromUI(){
      filters.windows = Array.from(document.querySelectorAll("#windowFilters input:checked")).map(i=>i.value);
      filters.pons    = Array.from(document.querySelectorAll("#ponFilters input:checked")).map(i=>i.value);
      controlsModal.style.display = "none";

      const filtered = filterBoard(rawBoard, filters);
      const treeData = buildHierarchy(filtered);
      currentTreeData = treeData;
      drawTree(treeData);
    }

    function filterBoard(board, filters){
      const out = {};
      Object.entries(board).forEach(([pon, winObj]) => {
        if (!filters.pons.includes(pon)) return;
        const newWin = {};
        Object.entries(winObj || {}).forEach(([win, splits]) => {
          if (!filters.windows.includes(win)) return;
          newWin[win] = splits;
        });
        if (Object.keys(newWin).length) out[pon] = newWin;
      });
      return out;
    }

    // --------------- TREE BUILDING ----------------

    function buildHierarchy(board){
      // Root
      const root = {
        nodeType: "root",
        name: "üåê Merotra Network",
        children: []
      };

      const windowMap = {};

      Object.entries(board).forEach(([pon, winObj]) => {
        Object.entries(winObj || {}).forEach(([winName, splitterObj]) => {

          if (!windowMap[winName]){
            const winNode = {
              nodeType: "window",
              name: "ü™ü " + winName,
              rawWindow: winName,
              children: []
            };
            windowMap[winName] = winNode;
            root.children.push(winNode);
          }

          const winNode = windowMap[winName];

          // PON node
          const ponNode = {
            nodeType: "pon",
            name: "üîå " + pon,
            rawPon: pon,
            window: winName,
            children: [],
            total: 0,
            online: 0,
            offline: 0
          };

          // collect splitter entries
          const entries = [];
          Object.entries(splitterObj || {}).forEach(([splitName, info]) => {
            const users = Array.isArray(info.users) ? info.users : [];
            const userIds = users.map(u => String(u.id));
            const set = new Set(userIds);
            entries.push({
              splitterName: splitName,
              info,
              users,
              userIds,
              userSet: set
            });

            ponNode.total  += info.total || users.length || 0;
            ponNode.online += info.online || 0;
            ponNode.offline+= info.offline || 0;
          });

          if (entries.length === 0){
            winNode.children.push(ponNode);
            return;
          }

          // Sort by user-count desc ‚Üí primary first
          entries.sort((a,b)=> b.userIds.length - a.userIds.length);

          // create node for each
          const nodeEntries = entries.map(e => ({
            entry: e,
            node: makeSplitterNode(e, pon, winName)
          }));

          const primaryNode = nodeEntries[0].node;
          ponNode.children.push(primaryNode);

          // link children using subset logic
          for (let i=1; i<nodeEntries.length; i++){
            const child = nodeEntries[i];
            const childSet = child.entry.userSet;
            let parentNode = null;

            for (let j=i-1; j>=0; j--){
              const parentEntry = nodeEntries[j];
              if (isSubset(childSet, parentEntry.entry.userSet)){
                parentNode = parentEntry.node;
                break;
              }
            }

            if (!parentNode) parentNode = primaryNode;
            parentNode.children.push(child.node);
          }

          // untagged branch per node (non-leaf)
          const allNodes = nodeEntries.map(n => n.node);
          allNodes.forEach(node => {
            if (!node.children || node.children.length === 0) return;

            const parentSet = new Set(node.userIds);
            const childUnion = new Set();
            node.children.forEach(ch => {
              (ch.userIds || []).forEach(id => childUnion.add(id));
            });

            const leftover = [];
            parentSet.forEach(id => {
              if (!childUnion.has(id)) leftover.push(id);
            });

            if (leftover.length > 0){
              const users = leftover.map(id => ({ id, offline: false }));
              const otherNode = {
                nodeType: "untagged",
                name: "‚¨ú Other ("+leftover.length+")",
                rawSplitter: "Other",
                pon: pon,
                window: winName,
                users,
                userIds: leftover,
                total: leftover.length,
                online: leftover.length,
                offline: 0,
                tag: "",
                location: node.location,
                jcPic: node.jcPic,
                polePic: node.polePic,
                children: []
              };
              node.children.push(otherNode);
            }
          });

          winNode.children.push(ponNode);
        });
      });

      return root;
    }

    function makeSplitterNode(entry, pon, windowName){
      const info = entry.info || {};
      const users = entry.users || [];
      const userIds = entry.userIds || [];
      const total = info.total ?? users.length ?? 0;
      const online = info.online ?? (users.filter(u=>!u.offline).length);
      const offline= info.offline?? (users.filter(u=> u.offline).length);

      const emoji = emojiForSplitter(entry.splitterName);
      const label = `${emoji} ${entry.splitterName} (${total})`;

      return {
        nodeType: "splitter",
        name: label,
        rawSplitter: entry.splitterName,
        pon,
        window: windowName,
        users,
        userIds,
        total,
        online,
        offline,
        tag: info.tag || "",
        location: info.location || "",
        jcPic: info.jcPic || "",
        polePic: info.polePic || "",
        children: []
      };
    }

    function emojiForSplitter(splitName){
      const s = (splitName || "").toLowerCase();
      if (s.includes("link")) return "üîó";
      if (s.includes("pending")) return "‚è≥";
      if (s.includes("16")) return "üî∫";
      if (s.includes("8"))  return "üîµ";
      if (s.includes("4"))  return "üü•";
      if (s.includes("2"))  return "üü©";
      return "‚¨ú";
    }

    function isSubset(aSet, bSet){
      for (let v of aSet) if (!bSet.has(v)) return false;
      return true;
    }

    // --------------- DRAW TREE ----------------

    function drawTree(data){
      d3.select("#chart").select("svg").remove();

      const width = document.getElementById("chart").clientWidth;
      const height = document.getElementById("chart").clientHeight;

      const dx = 80;
      const dy = width > 900 ? 260 : 200;

      treeLayout = d3.tree().nodeSize([dx, dy]);

      root = d3.hierarchy(data, d => d.children || []);
      treeLayout(root);

      const svgRoot = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height);

      const zoom = d3.zoom().scaleExtent([0.4, 3])
        .on("zoom", (event) => g.attr("transform", event.transform));

      svgRoot.call(zoom);

      g = svgRoot.append("g").attr("transform", "translate(80,60)");

      const links = root.links();
      const nodes = root.descendants();

      // links
      g.selectAll(".link")
        .data(links)
        .enter()
        .append("path")
        .attr("class","link")
        .attr("d", d3.linkHorizontal().x(d=>d.y).y(d=>d.x))
        .attr("fill","none")
        .attr("stroke","#94a3b8")
        .attr("stroke-width",2);

      // nodes
      const node = g.selectAll(".node")
        .data(nodes)
        .enter()
        .append("g")
        .attr("class","node")
        .attr("transform", d=>`translate(${d.y},${d.x})`);

      // root icon
      node.filter(d => d.data.nodeType === "root")
        .append("circle")
        .attr("r",24)
        .attr("fill","#1e3a8a")
        .attr("stroke","#fff")
        .attr("stroke-width",3);

      // window nodes
      node.filter(d => d.data.nodeType === "window")
        .append("circle")
        .attr("r",20)
        .attr("fill","#1d4ed8")
        .attr("stroke","#fff")
        .attr("stroke-width",3);

      // PON nodes
      node.filter(d => d.data.nodeType === "pon")
        .append("circle")
        .attr("r",18)
        .attr("fill","#0f766e")
        .attr("stroke","#fff")
        .attr("stroke-width",3);

      // splitter + untagged
      node.filter(d => d.data.nodeType === "splitter" || d.data.nodeType === "untagged")
        .append("circle")
        .attr("r", d => d.data.nodeType === "splitter" ? 14 : 10)
        .attr("fill", d => d.data.nodeType === "untagged" ? "#6b7280" : colorForSplitter(d.data))
        .attr("stroke","#fff")
        .attr("stroke-width",2)
        .on("mousemove", handleMouseOver)
        .on("mouseout", () => tooltip.style.opacity = 0)
        .on("click", handleNodeClick);

      // Tag üî¥‚ùå ‚Üí blink red
      node.filter(d => d.data.nodeType === "splitter" && d.data.tag === "üî¥‚ùå")
        .select("circle")
        .classed("blink-red", true)
        .attr("fill", "#ef4444");

      // text labels
      node.append("text")
        .attr("dy","0.32em")
        .attr("x", d => d.children && d.depth > 0 ? -20 : 20)
        .attr("text-anchor", d => d.children && d.depth > 0 ? "end" : "start")
        .style("font-size", d => {
          if (d.data.nodeType === "root") return "14px";
          if (d.data.nodeType === "window") return "13px";
          if (d.data.nodeType === "pon") return "12px";
          return "11px";
        })
        .style("font-weight", d => d.data.nodeType === "root" || d.data.nodeType === "window" ? 700 : 500)
        .text(d => d.data.name);

      // PON + WINDOW hover (only tooltip, no popup)
      node.filter(d => d.data.nodeType === "pon" || d.data.nodeType === "window")
        .on("mousemove", handleMouseOver)
        .on("mouseout", () => tooltip.style.opacity = 0)
        .on("click", () => {}); // disable popup

      // auto-fit
      fitToView(svgRoot, g, zoom);
    }

    function colorForSplitter(data){
      // Tag üî¥‚ùå priority
      if (data.tag === "üî¥‚ùå") return "#ef4444";

      const total = data.total || 0;
      const offline = data.offline || 0;
      if (total === 0) return "#6b7280";
      const r = offline / total;
      if (r >= 1) return "#ef4444";
      if (r >= 0.5) return "#f59e0b";
      return "#10b981";
    }

    function fitToView(svgRoot, g, zoom){
      const chart = document.getElementById("chart");
      const bounds = g.node().getBBox();
      const fullWidth = chart.clientWidth;
      const fullHeight = chart.clientHeight;
      const widthScale = fullWidth / (bounds.width + 160);
      const heightScale = fullHeight / (bounds.height + 160);
      const scale = Math.min(2, Math.max(0.4, Math.min(widthScale, heightScale)));
      const tx = -(bounds.x)*scale + 40;
      const ty = -(bounds.y)*scale + 40;
      svgRoot.transition().duration(600).call(
        zoom.transform,
        d3.zoomIdentity.translate(tx,ty).scale(scale)
      );
    }

    // --------------- TOOLTIP ----------------

    function handleMouseOver(event, d){
      const data = d.data;
      let html = `<strong>${data.name}</strong><br/>`;

      if (data.nodeType === "window"){
        html += `Window`;
      } else if (data.nodeType === "pon"){
        html += `PON: ${data.rawPon}<br/>Total: ${data.total || 0}`;
      } else if (data.nodeType === "splitter" || data.nodeType === "untagged"){
        html += `Window: ${data.window}<br/>PON: ${data.pon}<br/>`;
        html += `Users: <strong>${data.total || (data.users ? data.users.length : 0)}</strong>`;
        if (typeof data.online === "number" && typeof data.offline === "number"){
          html += `<br/>Online: <span style="color:#22c55e">${data.online}</span>`;
          html += `<br/>Offline: <span style="color:#ef4444">${data.offline}</span>`;
        }
        if (data.tag){
          html += `<br/>Tag: ${data.tag}`;
        }
      }

      tooltip.innerHTML = html;
      tooltip.style.left = (event.pageX + 14) + "px";
      tooltip.style.top  = (event.pageY + 8) + "px";
      tooltip.style.opacity = 1;
    }

    // --------------- POPUP ----------------

    function handleNodeClick(event, d){
      const data = d.data;
      if (!(data.nodeType === "splitter" || data.nodeType === "untagged")) return;

      currentClickNode = data;

      const titleEl = document.getElementById("popupTitle");
      const pathEl  = document.getElementById("popupPath");
      const metaEl  = document.getElementById("popupMeta");
      const linksEl = document.getElementById("popupLinks");
      const listEl  = document.getElementById("popupUsers");

      titleEl.textContent = data.nodeType === "untagged"
        ? `‚¨ú Untagged users (${data.total || data.userIds.length})`
        : `${data.rawSplitter} ‚Äî Users`;

      // Path e.g. "Merotra ‚Üí O2I6P2 ‚Üí Link JC"
      pathEl.textContent = `${data.window} ‚Üí ${data.pon} ‚Üí ${data.rawSplitter}`;

      const total = data.total || (data.users ? data.users.length : 0);

      // Popup meta ‚Äî NO Window/PON/Splitter repeat, NO Online/Offline count
      metaEl.innerHTML = `
        <div><span class="font-semibold">Total users:</span> ${total}</div>
        <div><span class="font-semibold">Tag:</span> ${data.tag || "-"}</div>
      `;

      let linksHtml = "";
      if (data.location){
        linksHtml += `<span class="link-btn" onclick="openLink('${data.location}')">üìç Location</span>`;
      }
      if (data.jcPic){
        linksHtml += `<span class="link-btn" onclick="openLink('${data.jcPic}')">üì∏ JC Pic</span>`;
      }
      if (data.polePic){
        linksHtml += `<span class="link-btn" onclick="openLink('${data.polePic}')">ü™µ Pole Pic</span>`;
      }
      linksEl.innerHTML = linksHtml || "";

      // user list with TheMaster data
      listEl.innerHTML = "";
      const users = data.users || [];
      const statusMap = statusMaps[data.window] || {};

      users.forEach((u, idx) => {
        const id = (u.id ?? "").toString();
        const offlineFlag = !!u.offline;
        const info = statusMap[id] || {};
        const shownStatus = info.status || "";
        const name = info.name || "";
        const number = info.number || "";
        const addr = info.location || "";

        const row = document.createElement("div");
        row.className = "user-row" + (offlineFlag ? " offline" : "");

        let metaLineParts = [];
        if (name)   metaLineParts.push(name);
        if (number) metaLineParts.push(number);
        if (addr)   metaLineParts.push(addr);
        const metaText = metaLineParts.join(" ‚Ä¢ ");

        row.innerHTML = `
          <div>
            <div class="user-main">
              <span class="text-xs text-gray-500 mr-1">${idx+1}.</span>
              <span class="font-semibold">${id}</span>
            </div>
            <div class="user-meta">${metaText || "&nbsp;"}</div>
          </div>
          <div class="text-xs text-right" style="min-width:70px;">${shownStatus || ""}</div>
        `;
        listEl.appendChild(row);
      });

      popupModal.style.display = "flex";
    }

    function openLink(url){
      if (url) window.open(url, "_blank");
    }

    // --------------- POPUP DOWNLOADS ----------------

    function downloadPopupScreenshot(){
      const modalContent = document.getElementById("popupContent");
      if (!modalContent) return;
      html2canvas(modalContent, { backgroundColor: "#ffffff", scale: 2 }).then(canvas => {
        const link = document.createElement("a");
        const ts = new Date().toISOString().split("T")[0];
        link.download = `merotra-users-${ts}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }

    function downloadPopupCsv(){
      if (!currentClickNode) return;
      const data = currentClickNode;
      const users = data.users || [];
      const statusMap = statusMaps[data.window] || {};

      const header = ["Sr","User ID","Status","Name","Number","Location"];
      const rows = [header.join(",")];

      users.forEach((u, idx) => {
        const id = (u.id ?? "").toString();
        const info = statusMap[id] || {};
        const line = [
          idx+1,
          `"${id.replace(/"/g,'""')}"`,
          `"${(info.status || "").replace(/"/g,'""')}"`,
          `"${(info.name || "").replace(/"/g,'""')}"`,
          `"${(info.number || "").replace(/"/g,'""')}"`,
          `"${(info.location || "").replace(/"/g,'""')}"`
        ].join(",");
        rows.push(line);
      });

      const csv = rows.join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const ts = new Date().toISOString().split("T")[0];
      a.href = url;
      a.download = `merotra-users-${ts}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // expose helpers for inline onclick
    window.openLink = openLink;
    window.selectAll = selectAll;
    window.deselectAll = deselectAll;
  </script>

</body>
</html>
