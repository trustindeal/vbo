<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Merotra Tree ‚Äî Final Build</title>

  <!-- D3 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Your CSS -->
  <link rel="stylesheet" href="adv.css">

  <!-- Minimal fallback (same as your working file) -->
  <style>
    :root{font-family:Inter,system-ui,Arial}
    body{margin:0;padding:0;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);color:#111827;height:100vh;overflow:hidden}
    #chart{width:100%;height:calc(100vh - 60px);overflow:hidden}
    .tooltip{position:absolute;pointer-events:none;background:rgba(15,23,42,0.9);color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;opacity:0;transition:.12s;z-index:999}
  </style>
</head>

<body>

<!-- Header -->
<div class="header">
  <div>
    <div class="header-title">üåê Merotra Network ‚Äî Clean Column Tree</div>
    <div class="header-sub">Window ‚Üí PON ‚Üí Level1 ‚Üí Level2 ‚Üí ...</div>
  </div>

  <div style="display:flex; gap:8px; align-items:center;">
    <button class="btn" id="btnSearchToggle">üîç Search</button>
    <button class="btn" id="reloadBtn">Reload</button>
  </div>
</div>

<!-- Search Drawer -->
<div id="searchDrawer" style="
  position:absolute; top:60px; right:20px; width:260px;
  background:white; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.15);
  padding:12px; z-index:99; display:none;
">
  <div style="font-weight:700; margin-bottom:6px;">Search User</div>
  <input id="searchBox" placeholder="Enter user ID..." 
         style="width:100%; padding:6px 10px; border-radius:8px; border:1px solid #cbd5e1;">
  <button id="searchBtn" class="btn" style="width:100%; margin-top:8px;">Search</button>
</div>

<!-- SVG -->
<div id="chart"></div>
<div id="tooltip" class="tooltip"></div>

<!-- POPUP -->
<div id="popupModal" class="popup-backdrop" style="display:none">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;">
      <div>
        <h2 id="popupTitle" style="margin:0;font-size:16px"></h2>
        <div id="popupPath" style="font-size:12px;color:#475569"></div>
      </div>
      <button id="popupClose" class="btn btn-secondary" style="height:30px">Close</button>
    </div>
    <div id="popupMeta" style="font-size:13px;color:#334155;margin:8px 0"></div>

    <div style="max-height:380px;overflow:auto">
      <table id="popupUsersTable" class="user-table"></table>
    </div>
  </div>
</div>

<script>
/* =====================================================
   CONFIG
===================================================== */
const BOARD_URL =
 "https://script.google.com/macros/s/AKfycbzItUueYIqcUuCn2cDaTTrWIF0LiilUxOXhhL-4b4D9aUlEo8Ov9pasR44d6JSM3h1t/exec?mode=board";

let rawJson = null;
const tooltip = document.getElementById("tooltip");


/* =====================================================
   SIMPLE UI BINDINGS
===================================================== */
document.getElementById("reloadBtn").onclick = () => loadAndRender();
document.getElementById("btnSearchToggle").onclick = toggleSearch;
document.getElementById("searchBtn").onclick = runSearch;
document.getElementById("popupClose").onclick = () => {
  document.getElementById("popupModal").style.display = "none";
};


/* =====================================================
   LOAD JSON + RENDER
===================================================== */
async function loadAndRender() {
  try {
    setLoading(true);
    const res = await fetch(BOARD_URL);
    const j = await res.json();
    rawJson = j;
    renderTree(j);
  } catch (e) {
    alert("Load failed");
  } finally {
    setLoading(false);
  }
}

function setLoading(v){
  const b = document.getElementById("reloadBtn");
  b.disabled = v;
  b.textContent = v ? "Loading..." : "Reload";
}


/* =====================================================
   RENDER TREE (CENTERED COLUMNS)
===================================================== */
function renderTree(data) {
  const chart = document.getElementById("chart");
  chart.innerHTML = "";

  const svg = d3.select("#chart")
      .append("svg")
      .attr("width","100%")
      .attr("height","100%");

  const g = svg.append("g");

  const zoom = d3.zoom().scaleExtent([0.4, 2])
     .on("zoom", e => g.attr("transform", e.transform));
  svg.call(zoom);

  const leftPad = 40;
  const colWidth = 220;
  const nodeGap = 55;
  const nodeR = 12;

  let currY = 30;


  /* -------- loop windows -------- */
  data.windows.forEach(win => {
    const winName = win.window;

    g.append("text")
      .attr("x", leftPad)
      .attr("y", currY)
      .text(winName)
      .attr("font-weight",700)
      .attr("font-size",14);

    currY += 20;

    win.pons.forEach(pon => {

      const levels = pon.levels.sort((a,b)=>a.level-b.level);
      const maxNodes = Math.max(
        1,
        ...levels.map(l=>l.splitters.length)
      );

      const blockH = Math.max(120, maxNodes*nodeGap + 50);
      const centerY = currY + blockH/2;

      /* ---- Window NODE ---- */
      const winX = leftPad;
      const winY = centerY;

      /* ---- PON NODE ---- */
      const ponX = winX + colWidth;
      const ponY = centerY;

      g.append("circle")
        .attr("cx", ponX)
        .attr("cy", ponY)
        .attr("r", nodeR+4)
        .attr("fill","#0f766e")
        .attr("stroke","#fff")
        .attr("stroke-width",2);

      g.append("text")
        .attr("x", ponX + nodeR + 8)
        .attr("y", ponY+4)
        .text(pon.pon)
        .attr("font-size",12);

      /* -------- LINK: Window ‚Üí PON -------- */
      g.append("line")
        .attr("x1", winX+40)
        .attr("y1", winY)
        .attr("x2", ponX - nodeR - 4)
        .attr("y2", ponY)
        .attr("stroke", randomBranch(pon.pon))
        .attr("stroke-width",2);


      /* ===== DRAW LEVEL SPLITTERS ===== */
      const levelPos = [];

      levels.forEach((lvl, i) => {
        const sx = ponX + colWidth + i*colWidth;
        const sCount = lvl.splitters.length;
        const totalH = (sCount-1)*nodeGap;
        const sy = centerY - totalH/2;

        levelPos[i] = [];

        lvl.splitters.forEach((sp, idx) => {
          const x = sx;
          const y = sy + idx*nodeGap;

          levelPos[i].push({x,y, sp});

          // circle
          g.append("circle")
            .attr("cx",x)
            .attr("cy",y)
            .attr("r",nodeR)
            .attr("fill","#10b981")
            .attr("stroke","#fff")
            .attr("stroke-width",2)
            .style("cursor","pointer")
            .on("mousemove",(e)=> showTip(e,sp))
            .on("mouseout", hideTip)
            .on("click", ()=> openPopup(sp, pon.pon, winName));

          // label
          g.append("text")
            .attr("x", x + nodeR + 6)
            .attr("y", y + 4)
            .text(`${sp.type} (${sp.total})`)
            .attr("font-size",11);

          // record ID
          g.append("text")
            .attr("x", x)
            .attr("y", y + nodeR + 12)
            .text(sp.recordId)
            .attr("font-size",10)
            .attr("fill","#64748b")
            .attr("text-anchor","middle");
        });
      });


      /* ===== LINKS: PON ‚Üí Level1 ===== */
      if(levelPos[0]){
        levelPos[0].forEach(ch => drawLink({x:ponX,y:ponY}, {x:ch.x,y:ch.y}, randomBranch(pon.pon)));
      }

      /* ===== LINKS: LevelN ‚Üí LevelN+1 ===== */
      for(let i=0;i<levelPos.length-1;i++){
        const parents = levelPos[i];
        const children = levelPos[i+1];

        children.forEach(ch => {
          const cset = new Set(ch.sp.users);
          let linked = false;

          for(const p of parents){
            const pset = new Set(p.sp.users);

            for(const u of cset){
              if(pset.has(u)){
                drawLink({x:p.x,y:p.y},{x:ch.x,y:ch.y}, randomBranch(pon.pon));
                linked = true;
                break;
              }
            }
            if(linked) break;
          }
        });
      }

      currY += blockH + 20;
    });

    currY += 30;
  });


  fit(svg.node(), g.node());
}


/* =====================================================
   LINK + COLOR HELPERS
===================================================== */
const branchColors = {};
function randomBranch(key){
  if(branchColors[key]) return branchColors[key];
  const hue = Math.floor(Math.random()*360);
  return branchColors[key] = `hsl(${hue},70%,45%)`;
}

function drawLink(a,b,color){
  d3.select("svg g")
    .append("path")
    .attr("d", `M ${a.x} ${a.y} C ${(a.x+b.x)/2} ${a.y}, ${(a.x+b.x)/2} ${b.y}, ${b.x} ${b.y}`)
    .attr("fill","none")
    .attr("stroke",color)
    .attr("stroke-width",2)
    .attr("stroke-opacity",0.85);
}


/* =====================================================
   TOOLTIP + POPUP
===================================================== */
function showTip(e, sp){
  tooltip.style.opacity = 1;
  tooltip.style.left = (e.pageX+12)+"px";
  tooltip.style.top = (e.pageY+12)+"px";
  tooltip.innerHTML =
    `<strong>${sp.type}</strong><br>
     Record: ${sp.recordId}<br>
     Users: ${sp.total}`;
}
function hideTip(){ tooltip.style.opacity = 0; }

function openPopup(sp, pon, win){
  const m = document.getElementById("popupModal");
  document.getElementById("popupTitle").textContent = `${sp.type}`;
  document.getElementById("popupPath").textContent = `${win} ‚Üí ${pon} ‚Üí ${sp.recordId}`;
  document.getElementById("popupMeta").innerHTML = `<strong>Total Users:</strong> ${sp.total}`;

  const tbl = document.getElementById("popupUsersTable");
  tbl.innerHTML = `<thead><tr><th>#</th><th>User</th></tr></thead><tbody>` +
    sp.users.map((u,i)=> `<tr><td>${i+1}</td><td>${u}</td></tr>`).join("") +
    `</tbody>`;

  m.style.display = "flex";
}


/* =====================================================
   SEARCH
===================================================== */
function toggleSearch(){
  const d = document.getElementById("searchDrawer");
  d.style.display = (d.style.display==="none" || d.style.display==="") ? "block" : "none";
}

function runSearch(){
  const val = document.getElementById("searchBox").value.trim();
  if(!val) return;

  // simple highlight: scan all splitters
  let found = null;

  rawJson.windows.forEach(w=>{
    w.pons.forEach(p=>{
      p.levels.forEach(l=>{
        l.splitters.forEach(s=>{
          if(s.users.includes(val)) found = {s,p,w};
        });
      });
    });
  });

  if(!found){ alert("User not found"); return; }

  openPopup(found.s, found.p.pon, found.w.window);

  // optional: auto pan to node (can add)
}


/* =====================================================
   FIT TO VIEW
===================================================== */
function fit(svg, g){
  try{
    const box = g.getBBox();
    const w = svg.clientWidth;
    const h = svg.clientHeight;
    const scale = Math.min(1, Math.min(
      w/(box.width+100),
      h/(box.height+100)
    ));
    const tx = -box.x*scale + 20;
    const ty = -box.y*scale + 20;

    d3.select(svg).call(
      d3.zoom().transform,
      d3.zoomIdentity.translate(tx,ty).scale(scale)
    );
  }catch(e){}
}


/* =====================================================
   INIT
===================================================== */
loadAndRender();

</script>
</body>
</html>
