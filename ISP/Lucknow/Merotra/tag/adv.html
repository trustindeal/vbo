<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Merotra ‚Äî Level Tree</title>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{font-family:Inter,system-ui,Arial}
    body{margin:0;padding:12px;background:#f8fafc;color:#0f172a}

    #chart{width:100%;height:74vh;border-radius:8px;background:#fff;
      padding:8px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}

    .tooltip{position:absolute;pointer-events:none;background:#111827;color:#fff;
      padding:6px 8px;border-radius:6px;font-size:12px;opacity:0;transition:opacity .12s}

    /* dotted links */
    .dotted-link{
      stroke:#94a3b8;
      stroke-width:2;
      fill:none;
      stroke-dasharray:4 4;
    }
  </style>
</head>
<body>

<!-- HEADER + POPUP + FILTERS ‚Äî SAME AS YOUR OLD HTML -->
<!-- ---------------------------------------------------- -->
<div class="header">
  <div>
    <div class="header-title">üåê Merotra Network Tree</div>
    <div class="header-sub">Window ‚Üí PON ‚Üí Level 1 ‚Üí Level 2 ‚Üí ‚Ä¶</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="controlsBtn" class="btn btn-secondary">Filters</button>
    <button id="reloadBtn" class="btn">Reload</button>
  </div>
</div>

<div id="chart"></div>
<div id="tooltip" class="tooltip"></div>

<!-- POPUP + FILTERS unchanged ‚Äî omitted here for brevity -->
<!-- (USE YOUR EXISTING POPUP + FILTER HTML EXACTLY) -->

<script>
/* -------------------------------------------
   CONFIG
------------------------------------------- */
const BOARD_URL = "YOUR_GOOGLE_SCRIPT_URL";  // Replace with your script URL

/* -------------------------------------------
   HELPERS
------------------------------------------- */
function parsePon(str){
  const m = str.match(/O(\d+)I(\d+)P(\d+)/i);
  if(!m) return {olt:9999,ip:9999,port:9999};
  return {olt:+m[1], ip:+m[2], port:+m[3]};
}

/* -------------------------------------------
   FETCH + BUILD TREE FOR NEW JSON FORMAT
------------------------------------------- */
async function loadAll(){
  const res = await fetch(BOARD_URL);
  const json = await res.json();
  const treeData = buildHierarchyFromNewJson(json);
  drawTree(treeData);
}

function buildHierarchyFromNewJson(data){

  const root = { name:"üåê Merotra Network", nodeType:"root", children:[] };

  data.windows.forEach(win => {
    const winNode = {
      name:"ü™ü " + win.window,
      nodeType:"window",
      children:[]
    };
    root.children.push(winNode);

    /* sort PON by OLT ‚Üí IP ‚Üí PORT */
    const sortedPons = win.pons.sort((a,b)=>{
      const A = parsePon(a.pon), B = parsePon(b.pon);
      if(A.olt !== B.olt) return A.olt - B.olt;
      if(A.ip !== B.ip) return A.ip - B.ip;
      return A.port - B.port;
    });

    sortedPons.forEach(pon => {
      const ponNode = {
        name:"üîå " + pon.pon,
        nodeType:"pon",
        children:[]
      };
      winNode.children.push(ponNode);

      /* Levels appear as separate columns ‚Äî keep order */
      pon.levels.forEach(level => {
        const levelNode = {
          name:"Level " + level.level,
          nodeType:"level",
          children:[]
        };
        ponNode.children.push(levelNode);

        /* Splitters in exact SHEET ORDER */
        level.splitters.forEach(sp => {
          levelNode.children.push({
            name: sp.recordId + " ‚Ä¢ " + sp.type + " (" + sp.total + ")",
            nodeType:"splitter",
            recordId: sp.recordId,
            splitType: sp.type,
            users: sp.users,
            total: sp.total,
            children:[]
          });
        });
      });
    });
  });

  return root;
}

/* -------------------------------------------
   DRAW TREE (column layout + dotted links)
------------------------------------------- */
function drawTree(data){

  d3.select("#chart").select("svg").remove();
  const width = document.getElementById("chart").clientWidth;
  const height = document.getElementById("chart").clientHeight;

  const dx = 70;
  const dy = 200;

  const root = d3.hierarchy(data);
  const tree = d3.tree().nodeSize([dx, dy]);
  tree(root);

  const svg = d3.select("#chart")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.append("g").attr("transform", "translate(40,40)");

  /* dotted links */
  g.selectAll(".link")
    .data(root.links())
    .enter()
    .append("path")
      .attr("class","dotted-link")
      .attr("d", d3.linkHorizontal()
          .x(d=>d.y)
          .y(d=>d.x)
      );

  /* nodes */
  const node = g.selectAll(".node")
    .data(root.descendants())
    .enter()
    .append("g")
      .attr("transform", d=>`translate(${d.y},${d.x})`);

  /* circle style per type */
  node.append("circle")
    .attr("r", d=>{
      if(d.data.nodeType==="root") return 22;
      if(d.data.nodeType==="window") return 18;
      if(d.data.nodeType==="pon") return 16;
      if(d.data.nodeType==="level") return 14;
      return 12; // splitter
    })
    .attr("fill", d=>{
      if(d.data.nodeType==="root") return "#1e3a8a";
      if(d.data.nodeType==="window") return "#2563eb";
      if(d.data.nodeType==="pon") return "#0d9488";
      if(d.data.nodeType==="level") return "#6366f1";
      return "#10b981"; // splitter
    })
    .attr("stroke","#fff")
    .attr("stroke-width",2);

  /* text */
  node.append("text")
    .attr("dy","0.32em")
    .attr("x", d => d.children ? -20 : 20)
    .attr("text-anchor", d => d.children ? "end" : "start")
    .style("font-size","12px")
    .text(d => d.data.name);
}

/* -------------------------------------------
   START
------------------------------------------- */
loadAll();

</script>
</body>
</html>
