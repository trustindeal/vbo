<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VBO Sheet Viewer</title>

  <!-- Modern Clean UI Using Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">

  <h2 class="text-3xl font-bold text-center mb-4 text-gray-800">VBO Sheet Data</h2>

  <div class="text-center mb-6">
    <button id="refreshBtn" onclick="loadData()"
      class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl shadow-md text-lg">
      REFRESH
    </button>
  </div>

  <!-- All cards (Row 1, Row 2, and combined Row 3+4) -->
  <div id="mainCards" class="space-y-6"></div>

  <script>
    const sheetCSV = "https://docs.google.com/spreadsheets/d/1WzR7qR-AAJup_hzNCHIC1fxYsVR_RSxR2mAZ7FcMWcM/export?format=csv&gid=0";

    function extractFields(r) {
      return {
        time: r[0] || "",        // A - Time
        tagBy: r[2] || "",       // C - Tag by
        location: r[3] || "",    // D - Location
        jcPic: r[4] || "",       // E - JC pic link
        polePic: r[5] || "",     // F - Pole pic
        lineName: r[7] || "",    // G - Line Name
        splitter: r[8] || "",    // H - Splitter
        fiber: r[9] || "",       // I - Fiber
        window: r[14] || "",     // O - Window
        tagId: r[15] || "",      // P - Tag ID
        totalUsers: r[24] || "", // Y - Total users (approx index)
        offlineUsers: r[25] || "", // Z - Offline users
        onlineUsers: r[26] || "",  // AA - Online users
        splitterStatus: r[27] || "" // AB - Splitter status
      };
    }

    function extractUsers(r) {
      // Users from Y to EV  (index 24 to 151 approx)
      return r.slice(24, 152).map(x => x.trim()).filter(x => x !== "");
    }

    function buildCard(row, extraRow = null) {
      const f = extractFields(row);
      let users = extractUsers(row);
      if (extraRow) {
        users = users.concat(extractUsers(extraRow));
      }

      let usersHTML = "";
      if (users.length) {
        usersHTML = `
          <div class="mt-4">
            <p class="font-semibold text-gray-800 mb-2">Users:</p>
            <div class="flex flex-wrap gap-2">
              ${users.map(u => `<span class='bg-blue-50 text-blue-800 text-sm px-2 py-1 rounded-full border border-blue-200'>${u}</span>`).join("")}
            </div>
          </div>
        `;
      }

      return `
        <div class="bg-white p-6 rounded-2xl shadow-md max-w-3xl mx-auto border border-gray-200">
          <div class="grid md:grid-cols-2 gap-3 text-gray-800 text-sm md:text-base">
            <p><span class='font-semibold'>Time:</span> ${f.time}</p>
            <p><span class='font-semibold'>Tag By:</span> ${f.tagBy}</p>
            <p><span class='font-semibold'>Location:</span> ${f.location}</p>
            <p><span class='font-semibold'>Line Name:</span> ${f.lineName}</p>
            <p><span class='font-semibold'>Splitter:</span> ${f.splitter}</p>
            <p><span class='font-semibold'>Fiber:</span> ${f.fiber}</p>
            <p><span class='font-semibold'>Window:</span> ${f.window}</p>
            <p><span class='font-semibold'>Tag ID:</span> ${f.tagId}</p>
            <p><span class='font-semibold'>Total Users:</span> ${f.totalUsers}</p>
            <p><span class='font-semibold'>Offline Users:</span> ${f.offlineUsers}</p>
            <p><span class='font-semibold'>Online Users:</span> ${f.onlineUsers}</p>
            <p><span class='font-semibold'>Splitter Status:</span> ${f.splitterStatus}</p>
          </div>
          <div class="mt-4 flex flex-wrap gap-4">
            ${f.jcPic ? `<a href='${f.jcPic}' target='_blank' class='text-blue-600 underline'>JC Pic</a>` : ""}
            ${f.polePic ? `<a href='${f.polePic}' target='_blank' class='text-blue-600 underline'>Pole Pic</a>` : ""}
          </div>
          ${usersHTML}
        </div>
      `;
    }

    async function loadData() {
      const mainDiv = document.getElementById("mainCards");
      mainDiv.innerHTML = "<p class='text-center text-gray-600'>Loading...</p>";

      const res = await fetch(sheetCSV);
      const data = await res.text();
      const rows = data.split("\n").map(r => r.split(","));

      // Remove very first row if it's empty/meta
      const dataRows = rows.slice(0).filter((r, i) => r.join('').trim() !== "");

      // Expecting 4 data rows -> make 3 cards:
      // Card 1 -> Row 1
      // Card 2 -> Row 2
      // Card 3 -> Row 3 + Row 4 combined users
      const r1 = dataRows[0] || null;
      const r2 = dataRows[1] || null;
      const r3 = dataRows[2] || null;
      const r4 = dataRows[3] || null;

      let html = "";
      if (r1) html += buildCard(r1);
      if (r2) html += buildCard(r2);
      if (r3 || r4) html += buildCard(r3 || r4, r3 && r4 ? r4 : null);

      mainDiv.innerHTML = html || "<p class='text-center text-gray-500'>No data found.</p>";
    }

    loadData();
  </script>

</body>
</html>
