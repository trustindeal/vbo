<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VBO Sheet Viewer â€” FINAL FIXED</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">

  <h2 class="text-3xl font-bold text-center mb-4 text-gray-800">VBO Sheet Data</h2>

  <div class="text-center mb-6">
    <button onclick="loadData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl shadow-md text-lg">REFRESH</button>
  </div>

  <div id="mainCards" class="space-y-6"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyfwYPZq_e4TItpYAQKtnVvi4q9U6UKQN6m1jZ6Utc7KAk4cjNLYdY-lWFd44SE_mC0/exec";

    async function loadData() {
      const main = document.getElementById("mainCards");
      main.innerHTML = "<p class='text-center text-gray-600'>Loading...</p>";

      try {
        const res = await fetch(API_URL, { method: "GET" });
        const text = await res.text();

        // FIX: Extract pure JSON if wrapped in HTML
        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {
          const clean = text.match(/\{[\s\S]*\}/);
          if (!clean) throw new Error("Invalid JSON from API");
          json = JSON.parse(clean[0]);
        }

        if (!json.rows) throw new Error("JSON missing rows");

        const rows = json.rows.filter(r => r.join("").trim() !== "");
        const cards = [];

        if (rows[0]) cards.push(buildCard(rows[0]));
        if (rows[1]) cards.push(buildCard(rows[1]));
        if (rows[2] || rows[3]) cards.push(buildCard(rows[2] || rows[3], rows[3]));

        main.innerHTML = cards.join("");

      } catch (err) {
        console.error(err);
        main.innerHTML = "<p class='text-center text-red-600'>Failed to load API data</p>";
      }
    }

    function extractUsers(r) {
      return r.slice(24, 152).filter(x => x && x.trim());
    }

    function buildCard(row, extra = null) {
      const f = {
        time: row[0] || "",
        tagBy: row[2] || "",
        location: row[3] || "",
        jcPic: row[4] || "",
        polePic: row[5] || "",
        lineName: row[6] || "",
        splitter: row[7] || "",
        fiber: row[8] || "",
        window: row[10] || "",
        tagId: row[23] || "",
        totalUsers: row[154] || "",
        offlineUsers: row[155] || "",
        onlineUsers: row[156] || "",
        splitterStatus: row[157] || ""
      };

      let users = extractUsers(row);
      if (extra) users = users.concat(extractUsers(extra));

      return `
        <div class='bg-white p-6 rounded-2xl shadow-md max-w-3xl mx-auto border border-gray-200'>
          <div class='grid md:grid-cols-2 gap-3 text-gray-800 text-sm md:text-base'>
            <p><span class='font-semibold'>Time:</span> ${f.time ? new Date(f.time).toLocaleString() : ""}</p>
            <p><span class='font-semibold'>Tag By:</span> ${f.tagBy}</p>
            <p><span class='font-semibold'>Location:</span></p>
            ${f.location ? `<a href='${f.location}' target='_blank' class='bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded-lg text-sm'>Open Map</a>` : ""}
            <p><span class='font-semibold'>Line Name:</span> ${f.lineName}</p>
            <p><span class='font-semibold'>Splitter:</span> ${f.splitter}</p>
            <p><span class='font-semibold'>Fiber:</span> ${f.fiber}</p>
            <p><span class='font-semibold'>Window:</span> ${f.window}</p>
            <p><span class='font-semibold'>Tag ID:</span> ${f.tagId}</p>
            <p><span class='font-semibold'>Total Users:</span> ${f.totalUsers}</p>
            <p><span class='font-semibold'>Offline Users:</span> ${f.offlineUsers}</p>
            <p><span class='font-semibold'>Online Users:</span> ${f.onlineUsers}</p>
            <p><span class='font-semibold'>Splitter Status:</span> ${f.splitterStatus}</p>
          </div>

          <div class='mt-6 flex flex-wrap gap-4'>
            ${f.jcPic ? `<a href='${f.jcPic}' target='_blank' class='bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow text-sm'>JC Pic</a>` : ""}
            ${f.polePic ? `<a href='${f.polePic}' target='_blank' class='bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow text-sm'>Pole Pic</a>` : ""}
          </div>

          ${users.length ? `
            <div class='mt-4'>
              <p class='font-semibold text-gray-800 mb-2'>Users:</p>
              <div class='flex flex-wrap gap-2'>
                ${users.map(u => `<span class='bg-blue-50 text-blue-800 text-sm px-2 py-1 rounded-full border border-blue-200'>${u}</span>`).join("")}
              </div>
            </div>` : ""}
        </div>`;
    }

    loadData();
  </script>

</body>
</html>
