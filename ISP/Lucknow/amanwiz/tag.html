<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üåê Merotra Fiber Network</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background: #f3f4f6; font-family: "Inter", sans-serif; overflow: hidden; }
.node circle { stroke: #333; stroke-width: 2px; cursor: pointer; transition: fill 0.3s; }
.node text { font-size: 13px; fill: #333; pointer-events: none; }
.link { fill: none; stroke: #555; stroke-width: 3px; }
.tooltip {
  position: absolute;
  text-align: left;
  padding: 6px 10px;
  font-size: 12px;
  background: rgba(0,0,0,0.7);
  color: #fff;
  border-radius: 5px;
  pointer-events: none;
}
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
.modal-content { background: white; padding: 20px; border-radius: 10px;
  max-height: 80%; overflow-y: auto; width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
</style>
</head>
<body>
<h1 class="text-3xl font-bold mb-6 text-gray-800 text-center">üåê Merotra Fiber Network</h1>
<p class="text-gray-500 mb-4 text-center">Loading network data...</p>
<div id="chart"></div>

<div id="popup" class="modal hidden">
  <div class="modal-content">
    <h2 class="text-xl font-semibold mb-2" id="popupTitle"></h2>
    <ul id="userList" class="list-disc pl-5 text-sm text-gray-700"></ul>
    <button onclick="closePopup()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Close</button>
  </div>
</div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbypM1hegFj6sqo2UGx3zX1xPVSL6dxcqlQqQ9zPJhNMcvS08rbfMnxiKkSzv6a2PxYP/exec?mode=data";
const tooltip = d3.select("body").append("div").attr("class","tooltip").style("opacity",0);

fetch(apiUrl)
.then(res => res.json())
.then(data => {
  document.querySelector("p.text-gray-500").remove();
  drawTree(data);
})
.catch(err => {
  console.error("Fetch error:", err);
  document.body.innerHTML += `<p class='text-red-600'>‚ùå Could not fetch data. Check API URL.</p>`;
});

let svg, svgGroup, treeLayout, rootHierarchy, nodes, links;

function drawTree(data){
  const root = { name:"Merotra Network", children:[] };

  Object.entries(data).forEach(([pon, windows])=>{
    Object.entries(windows).forEach(([win,splits])=>{
      // Window node
      let winNode = root.children.find(n=>n.name===win);
      if(!winNode){ winNode={name:win,children:[]}; root.children.push(winNode); }

      // PON node
      let ponNode = winNode.children.find(n=>n.name===pon);
      if(!ponNode){ ponNode={name:pon,children:[]}; winNode.children.push(ponNode); }

      // Splitters sorted by total users descending
      const sortedSplitters = Object.entries(splits).sort((a,b)=> (b[1].total||0) - (a[1].total||0));
      sortedSplitters.forEach(([split,info])=>{
        let splitterColor = "#10b981"; // green default

        if(info.total > 0){
          const offlinePercent = info.offline / info.total;
          if(info.offline === info.total) splitterColor = "red";
          else if(offlinePercent >= 0.5) splitterColor = "orange";
        }

        ponNode.children.push({ name:`${split} (${info.total||0} users)`, color:splitterColor, info });
      });

      // Compute PON color based on aggregate splitters
      const totalUsersSum = ponNode.children.reduce((acc,c)=>acc + (c.info?.total||0),0);
      const offlineUsersSum = ponNode.children.reduce((acc,c)=>acc + (c.info?.offline||0),0);
      let ponColor = "#10b981"; // green
      if(totalUsersSum>0){
        const offlinePercent = offlineUsersSum/totalUsersSum;
        if(offlineUsersSum === totalUsersSum) ponColor = "red";
        else if(offlinePercent >=0.5) ponColor = "orange";
      }
      ponNode.color = ponColor;

      // Sort PONs by second character
      winNode.children.sort((a,b)=>{
        const aDigit=parseInt(a.name[1]);
        const bDigit=parseInt(b.name[1]);
        return aDigit-bDigit;
      });
    });
  });

  renderTree(root);
}

function renderTree(root){
  d3.select("#chart").selectAll("*").remove();

  const dx = 50, dy = 220;
  treeLayout = d3.tree().nodeSize([dx,dy]);
  rootHierarchy = d3.hierarchy(root);
  treeLayout(rootHierarchy);

  nodes = rootHierarchy.descendants();
  links = rootHierarchy.links();

  svg = d3.select("#chart").append("svg")
    .attr("width", window.innerWidth)
    .attr("height", window.innerHeight)
    .call(d3.zoom().scaleExtent([0.5,2]).on("zoom", e=> svgGroup.attr("transform", e.transform)))
    .append("g")
    .attr("transform","translate(50,50)");

  svgGroup = svg.append("g");

  const linkGenerator = d3.linkHorizontal().x(d=>d.y).y(d=>d.x);

  svgGroup.selectAll(".link")
    .data(links)
    .enter().append("path")
    .attr("class","link")
    .attr("d",linkGenerator);

  const node = svgGroup.selectAll(".node")
    .data(nodes)
    .enter().append("g")
    .attr("class","node")
    .attr("transform",d=>`translate(${d.y},${d.x})`);

  node.append("circle")
    .attr("r", d=>{
      if(d.depth===1) return 20; else if(d.depth===2) return 15; else return 10;
    })
    .attr("fill", d=>{
      if(d.depth===1) return "#3b82f6"; // Windows
      else if(d.depth===2) return d.data.color || "#10b981"; // PON
      else return d.data.color || "#10b981"; // Splitter
    })
    .on("mouseover",(event,d)=>{
      if(d.data.info){
        tooltip.transition().duration(200).style("opacity",0.9);
        tooltip.html(`Total: ${d.data.info.total}<br>Online: ${d.data.info.online}<br>Offline: ${d.data.info.offline}`)
          .style("left",(event.pageX+10)+"px").style("top",(event.pageY-20)+"px");
      }
    })
    .on("mouseout",()=>tooltip.transition().duration(500).style("opacity",0))
    .on("click",(event,d)=>{ if(d.data.info && d.data.info.users) showPopup(d); });

  node.append("text")
    .attr("dy","0.32em")
    .attr("x",d=>d.children?-12:12)
    .attr("text-anchor",d=>d.children?"end":"start")
    .text(d=>d.data.name);
}

// Popup
function showPopup(d){
  const popup=document.getElementById("popup");
  const list=document.getElementById("userList");
  const title=document.getElementById("popupTitle");
  popup.classList.remove("hidden");
  title.textContent=d.data.name+" ‚Äî Users";
  list.innerHTML="";
  d.data.info.users.forEach(u=>{
    const li=document.createElement("li");
    li.textContent=u;
    list.appendChild(li);
  });
}

function closePopup(){ document.getElementById("popup").classList.add("hidden"); }
</script>
</body>
</html>
